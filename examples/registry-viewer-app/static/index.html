<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoMind Registry Viewer</title>
    <style>
        :root {
            --glass-bg: rgba(10, 10, 15, 0.85);
            --glass-bg-light: rgba(20, 20, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-border-light: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --glass-blur: 24px;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.75);
            --text-muted: rgba(255, 255, 255, 0.5);
            --accent-blue: #0a84ff;
            --accent-purple: #da8fff;
            --accent-green: #32d74b;
            --accent-red: #ff6b6b;
            --accent-orange: #ffb340;
            --accent-teal: #64d2ff;
            --accent-pink: #ff6eb4;
            --border-subtle: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg,
                #0d0d12 0%,
                #1a1a2e 25%,
                #16213e 50%,
                #1a2744 75%,
                #0d0d12 100%);
            background-size: 400% 400%;
            animation: gradientShift 25s ease infinite;
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .app { display: flex; flex-direction: column; height: 100vh; padding: 16px; gap: 12px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            border-radius: 18px;
            border: 1px solid var(--glass-border-light);
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .header-left { display: flex; align-items: center; gap: 24px; }

        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 16px rgba(10, 132, 255, 0.4);
        }
        .logo h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .logo h1 span {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-nav {
            display: flex; gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px; border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .main-nav-btn {
            padding: 8px 16px; background: transparent;
            border: 1px solid transparent;
            border-radius: 6px; color: rgba(255, 255, 255, 0.7);
            font-size: 13px; font-weight: 500;
            letter-spacing: 0.3px;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
        }
        .main-nav-btn:hover:not(.active) {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 149, 0, 0.1);
        }
        .main-nav-btn.active {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.4) 0%, rgba(255, 149, 0, 0.2) 100%);
            border: 1px solid rgba(255, 149, 0, 0.6);
            color: #ffb84d;
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
        .main-nav-btn .nav-icon { font-size: 14px; }

        .header-controls { display: flex; align-items: center; gap: 24px; }
        .stats { display: flex; gap: 24px; font-size: 13px; font-weight: 500; }
        .stat { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
        .stat-value { font-weight: 600; font-size: 16px; }
        .stat-value.total { color: var(--accent-teal); }
        .stat-value.agents { color: var(--accent-purple); }
        .stat-value.tools { color: var(--accent-green); }
        .stat-value.records { color: var(--accent-pink); }
        .stat-value.tokens { color: var(--accent-orange); }

        .refresh-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--accent-blue), #0066cc);
            border: none; border-radius: 22px;
            color: white; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(10, 132, 255, 0.4);
        }
        .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(10, 132, 255, 0.5); }
        .refresh-btn:active { transform: translateY(0); }
        .refresh-btn.loading { opacity: 0.7; }
        .refresh-btn.loading .refresh-icon { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .auto-refresh {
            display: flex; align-items: center; gap: 8px;
            color: var(--text-secondary); font-size: 13px; font-weight: 500;
        }
        .auto-refresh input {
            width: 18px; height: 18px; cursor: pointer;
            accent-color: var(--accent-blue);
        }

        .main { display: flex; flex: 1; gap: 12px; overflow: hidden; }

        .list-panel {
            width: 55%; min-width: 400px;
            display: flex; flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            border-radius: 18px;
            border: 1px solid var(--glass-border-light);
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255,255,255,0.05);
            overflow: hidden;
        }

        .filters {
            display: flex; gap: 10px;
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .search-box {
            flex: 1;
            display: flex; align-items: center; gap: 10px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 12px; padding: 0 14px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .search-box:focus-within {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
        }
        .search-box input {
            flex: 1; background: none; border: none;
            color: var(--text-primary); font-size: 14px;
            padding: 12px 0; outline: none;
        }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-icon { color: var(--text-muted); font-size: 15px; }

        .filter-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            border-radius: 22px;
            color: var(--text-secondary);
            font-size: 13px; font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); }
        .filter-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.35);
        }

        .table-container { flex: 1; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead {
            position: sticky; top: 0;
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(12px);
            z-index: 10;
        }
        th {
            text-align: left; padding: 14px 18px;
            color: var(--text-muted);
            font-weight: 600; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.8px;
            border-bottom: 1px solid var(--border-subtle);
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.15s;
        }
        th.sortable:hover {
            color: var(--text-primary);
        }
        th.sortable::after {
            content: '⇅';
            margin-left: 6px;
            opacity: 0.4;
            font-size: 10px;
        }
        th.sortable.asc::after {
            content: '↑';
            opacity: 1;
            color: var(--accent-blue);
        }
        th.sortable.desc::after {
            content: '↓';
            opacity: 1;
            color: var(--accent-blue);
        }
        td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-subtle);
            vertical-align: middle;
        }
        tbody tr {
            cursor: pointer;
            transition: all 0.15s;
        }
        tbody tr:hover { background: rgba(255, 255, 255, 0.04); }
        tbody tr.selected {
            background: rgba(10, 132, 255, 0.15);
            border-left: 3px solid var(--accent-blue);
        }

        .type-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .type-badge.tool {
            background: rgba(50, 215, 75, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(50, 215, 75, 0.3);
        }
        .type-badge.agent {
            background: rgba(218, 143, 255, 0.2);
            color: var(--accent-purple);
            border: 1px solid rgba(218, 143, 255, 0.3);
        }
        .type-badge.plan_generation {
            background: rgba(50, 215, 75, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(50, 215, 75, 0.3);
        }
        .type-badge.tiered_selection {
            background: rgba(255, 179, 64, 0.2);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 179, 64, 0.3);
        }
        .type-badge.synthesis {
            background: rgba(218, 143, 255, 0.2);
            color: var(--accent-purple);
            border: 1px solid rgba(218, 143, 255, 0.3);
        }
        .type-badge.synthesis_streaming {
            background: rgba(218, 143, 255, 0.2);
            color: var(--accent-purple);
            border: 1px solid rgba(218, 143, 255, 0.3);
        }
        .type-badge.micro_resolution {
            background: rgba(100, 210, 255, 0.2);
            color: var(--accent-teal);
            border: 1px solid rgba(100, 210, 255, 0.3);
        }
        .type-badge.correction {
            background: rgba(255, 179, 64, 0.2);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 179, 64, 0.3);
        }
        .type-badge.semantic_retry {
            background: rgba(255, 110, 180, 0.2);
            color: var(--accent-pink);
            border: 1px solid rgba(255, 110, 180, 0.3);
        }
        .step-id-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: rgba(100, 210, 255, 0.15);
            color: var(--accent-teal);
            border: 1px solid rgba(100, 210, 255, 0.25);
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        /* HITL Priority badges */
        .priority-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .priority-badge.critical {
            background: rgba(255, 107, 107, 0.25);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.4);
            animation: pulse-critical 1.5s ease-in-out infinite;
        }
        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 8px 4px rgba(255, 107, 107, 0.2); }
        }
        .priority-badge.high {
            background: rgba(255, 179, 64, 0.2);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 179, 64, 0.3);
        }
        .priority-badge.normal {
            background: rgba(10, 132, 255, 0.2);
            color: var(--accent-blue);
            border: 1px solid rgba(10, 132, 255, 0.3);
        }
        .priority-badge.low {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* HITL Action badges (for DefaultAction) */
        .action-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .action-badge.approve {
            background: rgba(50, 215, 75, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(50, 215, 75, 0.3);
        }
        .action-badge.reject {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .action-badge.abort {
            background: rgba(255, 179, 64, 0.2);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 179, 64, 0.3);
        }

        /* HITL Interrupt point badges */
        .interrupt-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 600;
        }
        .interrupt-badge.plan_generated {
            background: rgba(50, 215, 75, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(50, 215, 75, 0.3);
        }
        .interrupt-badge.before_step {
            background: rgba(100, 210, 255, 0.2);
            color: var(--accent-teal);
            border: 1px solid rgba(100, 210, 255, 0.3);
        }
        .interrupt-badge.after_step {
            background: rgba(218, 143, 255, 0.2);
            color: var(--accent-purple);
            border: 1px solid rgba(218, 143, 255, 0.3);
        }
        .interrupt-badge.on_error {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        /* HITL Step progress */
        .step-progress {
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; color: var(--text-secondary);
        }
        .step-progress-bar {
            width: 60px; height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .step-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-teal));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* HITL Plan step cards */
        .plan-step-card {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s;
        }
        .plan-step-card:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        .plan-step-card.completed {
            border-left: 3px solid var(--accent-green);
        }
        .plan-step-card.current {
            border-left: 3px solid var(--accent-orange);
            background: rgba(255, 179, 64, 0.08);
        }
        .plan-step-card.pending {
            opacity: 0.7;
        }
        .plan-step-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .plan-step-id {
            font-size: 11px; font-weight: 600;
            color: var(--text-muted); text-transform: uppercase;
        }
        .plan-step-status {
            font-size: 11px; padding: 4px 10px; border-radius: 12px;
        }
        .plan-step-status.completed { background: rgba(50, 215, 75, 0.2); color: var(--accent-green); }
        .plan-step-status.current { background: rgba(255, 179, 64, 0.2); color: var(--accent-orange); }
        .plan-step-status.pending { background: rgba(255, 255, 255, 0.08); color: var(--text-muted); }
        .plan-step-capability {
            font-weight: 600; font-size: 14px;
            color: var(--accent-teal); margin-bottom: 8px;
        }
        .plan-step-description {
            font-size: 13px; color: var(--text-secondary);
            margin-bottom: 10px; line-height: 1.5;
        }
        .plan-step-params {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 11px; color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 12px; border-radius: 8px;
        }
        .plan-step-depends {
            font-size: 11px; color: var(--text-muted);
            margin-top: 10px;
        }

        .health-indicator { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
        .health-dot {
            width: 10px; height: 10px; border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        .health-dot.healthy {
            background: var(--accent-green);
            box-shadow: 0 0 8px rgba(50, 215, 75, 0.6);
        }
        .health-dot.unhealthy {
            background: var(--accent-red);
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.6);
        }
        .health-dot.unknown {
            background: var(--accent-orange);
            box-shadow: 0 0 8px rgba(255, 179, 64, 0.6);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .service-name { font-weight: 400; color: var(--text-secondary); }
        .time-ago { color: var(--text-muted); font-size: 12px; }
        .request-id {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }
        /* Allow request-id to expand in wider columns */
        td .request-id {
            max-width: calc(100% - 16px);
        }

        /* HITL parent-child row grouping styles */
        tr.child-row {
            background: rgba(255, 255, 255, 0.02);
        }
        tr.child-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        tr.child-row td:first-child {
            padding-left: 24px;
        }
        .child-indicator {
            color: var(--accent-cyan);
            font-size: 14px;
            margin-right: 8px;
            opacity: 0.7;
            flex-shrink: 0;
        }
        .hitl-resume-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(100, 210, 255, 0.15);
            color: var(--accent-cyan);
            vertical-align: middle;
        }
        tr.expandable td:nth-child(2)::before {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 4px solid var(--text-secondary);
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
            margin-right: 6px;
            opacity: 0.5;
            vertical-align: middle;
        }

        .status-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            border: 1px solid transparent;
            backdrop-filter: blur(8px);
        }
        .status-badge.success {
            background: rgba(50, 215, 75, 0.15);
            border-color: rgba(50, 215, 75, 0.4);
            color: var(--accent-green);
            box-shadow: 0 0 8px rgba(50, 215, 75, 0.1);
        }
        .status-badge.error {
            background: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.4);
            color: var(--accent-red);
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.1);
        }
        .status-badge.interrupted {
            background: rgba(255, 179, 64, 0.15);
            border-color: rgba(255, 179, 64, 0.4);
            color: var(--accent-orange);
            box-shadow: 0 0 8px rgba(255, 179, 64, 0.1);
        }

        /* LLM Debug view: narrower list, wider detail for better content visibility */
        .main.llm-debug-view .list-panel { width: 35%; min-width: 280px; max-width: 70%; }
        .main.llm-debug-view .detail-panel { flex: 1; min-width: 300px; }

        /* HITL view: similar to LLM Debug */
        .main.hitl-view .list-panel { width: 40%; min-width: 320px; max-width: 70%; }
        .main.hitl-view .detail-panel { flex: 1; min-width: 300px; }

        /* DAG view: similar to HITL */
        .main.dag-view .list-panel { width: 35%; min-width: 320px; max-width: 70%; }
        .main.dag-view .detail-panel { flex: 1; min-width: 400px; }

        /* DAG Step Cards with modern glassmorphism (2026 liquid glass technique) */
        .dag-step-card {
            position: relative;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dag-step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 16px 16px 0 0;
        }
        .dag-step-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-color: rgba(255, 255, 255, 0.18);
            transform: translateY(-2px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        .dag-step-card.completed {
            border-left: 3px solid var(--accent-green);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1),
                        -6px 0 24px -10px rgba(50, 215, 75, 0.4);
        }
        .dag-step-card.failed {
            border-left: 3px solid var(--accent-red);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1),
                        -6px 0 24px -10px rgba(255, 107, 107, 0.4);
        }
        .dag-step-card.pending {
            border-left: 3px solid var(--accent-orange);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1),
                        -6px 0 24px -10px rgba(255, 179, 64, 0.4);
        }
        .dag-step-card.skipped {
            border-left: 3px solid var(--text-muted);
            opacity: 0.6;
        }
        .dag-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .dag-step-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dag-step-number {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
        }
        .dag-step-id {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .dag-step-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid transparent;
            backdrop-filter: blur(8px);
        }
        .dag-step-status.completed {
            background: rgba(50, 215, 75, 0.15);
            border-color: rgba(50, 215, 75, 0.4);
            color: var(--accent-green);
            box-shadow: 0 0 8px rgba(50, 215, 75, 0.1);
        }
        .dag-step-status.failed {
            background: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.4);
            color: var(--accent-red);
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.1);
        }
        .dag-step-status.pending {
            background: rgba(255, 179, 64, 0.15);
            border-color: rgba(255, 179, 64, 0.4);
            color: var(--accent-orange);
            box-shadow: 0 0 8px rgba(255, 179, 64, 0.1);
        }
        .dag-step-status.skipped {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            color: var(--text-muted);
        }
        .dag-step-status.blocked {
            background: rgba(10, 132, 255, 0.15);
            border-color: rgba(10, 132, 255, 0.4);
            color: #0a84ff;
            box-shadow: 0 0 8px rgba(10, 132, 255, 0.1);
        }
        .dag-step-body {
            margin-top: 12px;
        }
        .dag-step-info {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 8px 16px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .dag-step-label {
            color: var(--text-muted);
            font-weight: 500;
        }
        .dag-step-value {
            color: var(--text-secondary);
        }
        .dag-step-value.highlight {
            color: var(--accent-teal);
            font-weight: 500;
        }
        .dag-step-response {
            margin-top: 12px;
        }
        .dag-step-response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 12px;
            color: var(--accent-blue);
            transition: all 0.2s;
        }
        .dag-step-response-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        .dag-step-response-content {
            margin-top: 8px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            text-align: left;
            direction: ltr;
        }
        .dag-step-error {
            margin-top: 10px;
            padding: 12px 14px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
            font-size: 12px;
        }
        .dag-step-depends {
            margin-top: 12px;
            padding: 10px 12px;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        .dag-step-depends-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .dag-step-depends-row:last-child {
            margin-bottom: 0;
        }
        .dag-step-depends-label {
            color: var(--text-muted);
            min-width: 70px;
            font-weight: 500;
        }
        .dag-step-depends-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .dag-step-depends-item {
            background: rgba(10, 132, 255, 0.2);
            border: 1px solid rgba(10, 132, 255, 0.3);
            color: var(--accent-blue);
            padding: 3px 10px;
            border-radius: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 10px;
        }
        .dag-step-depends-item.used-by {
            background: rgba(218, 143, 255, 0.2);
            border: 1px solid rgba(218, 143, 255, 0.3);
            color: var(--accent-purple);
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        /* Timing badges with tooltips */
        .timing-badge {
            font-family: 'SF Mono', monospace;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: help;
            transition: all 0.2s ease;
            position: relative;
        }
        .timing-badge::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 14px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            white-space: pre-line;
            min-width: 200px;
            max-width: 280px;
            text-align: left;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
        }
        .timing-badge:hover::after {
            opacity: 1;
            visibility: visible;
        }
        .timing-badge.execution-time {
            background: rgba(100, 210, 255, 0.15);
            border: 1px solid rgba(100, 210, 255, 0.3);
            color: var(--accent-teal);
        }
        .timing-badge.execution-time:hover {
            background: rgba(100, 210, 255, 0.25);
            border-color: rgba(100, 210, 255, 0.5);
        }
        .timing-badge.wait-time {
            background: rgba(255, 179, 64, 0.15);
            border: 1px solid rgba(255, 179, 64, 0.3);
            color: var(--accent-orange);
        }
        .timing-badge.wait-time:hover {
            background: rgba(255, 179, 64, 0.25);
            border-color: rgba(255, 179, 64, 0.5);
        }

        /* DAG Visualization container with enhanced glassy styling */
        .dag-viz-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(180deg, rgba(15, 15, 25, 0.6) 0%, rgba(10, 10, 18, 0.8) 100%);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.04);
            overflow: hidden;
        }
        .dag-viz-header {
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        .dag-viz-title {
            font-weight: 500;
            font-size: 11px;
            margin-bottom: 4px;
            color: var(--text-primary);
            line-height: 1.35;
            /* Limit height for long prompts - max 2 lines */
            max-height: 2.7em; /* 2 lines * 1.35 line-height */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            cursor: pointer;
            transition: max-height 0.3s ease;
        }
        .dag-viz-title:hover {
            color: var(--accent-blue);
        }
        .dag-viz-title.expanded {
            max-height: none;
            -webkit-line-clamp: unset;
        }
        .dag-viz-meta {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Monaco', monospace;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        .dag-viz-meta-item {
            background: rgba(255, 255, 255, 0.06);
            padding: 1px 6px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 11px;
        }
        .dag-viz-meta-item.success {
            background: rgba(50, 215, 75, 0.15);
            border-color: rgba(50, 215, 75, 0.4);
            color: var(--accent-green);
            box-shadow: 0 0 8px rgba(50, 215, 75, 0.1);
        }
        .dag-viz-meta-item.error {
            background: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.4);
            color: var(--accent-red);
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.1);
        }
        .dag-viz-meta-item.interrupted {
            background: rgba(255, 179, 64, 0.15);
            border-color: rgba(255, 179, 64, 0.4);
            color: var(--accent-orange);
            box-shadow: 0 0 8px rgba(255, 179, 64, 0.1);
        }
        .dag-viz-canvas {
            flex: 1;
            min-height: 400px;
            /* Rich gradient background for glass effect contrast */
            background:
                radial-gradient(ellipse at 20% 30%, rgba(10, 132, 255, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 70%, rgba(218, 143, 255, 0.06) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(100, 210, 255, 0.03) 0%, transparent 60%),
                linear-gradient(180deg, rgba(15, 15, 25, 0.4) 0%, rgba(10, 10, 20, 0.6) 100%);
            position: relative;
        }
        .dag-viz-canvas::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }
        .dag-viz-legend {
            padding: 8px 16px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: center;
            gap: 16px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .dag-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.2s;
        }
        .dag-legend-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-1px);
        }
        .dag-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
        }
        .dag-legend-dot.completed { background: var(--accent-green); color: rgba(50, 215, 75, 0.6); }
        .dag-legend-dot.failed { background: var(--accent-red); color: rgba(255, 107, 107, 0.6); }
        .dag-legend-dot.pending { background: var(--accent-orange); color: rgba(255, 179, 64, 0.6); }
        .dag-legend-dot.skipped { background: #666; color: rgba(128, 128, 128, 0.4); }
        .dag-legend-dot.blocked { background: #0a84ff; color: rgba(10, 132, 255, 0.6); border: 1px dashed rgba(10, 132, 255, 0.8); }
        /* Full Flow legend dots - new node types */
        .dag-legend-dot.orchestrator { background: var(--accent-purple); color: rgba(218, 143, 255, 0.6); }
        .dag-legend-dot.llm-call { background: var(--accent-blue); color: rgba(10, 132, 255, 0.6); }
        .dag-legend-dot.checkpoint { background: var(--accent-orange); color: rgba(255, 179, 64, 0.6); }
        .dag-legend-dot.response { background: var(--accent-teal); color: rgba(100, 210, 255, 0.6); }
        /* Step-level HITL checkpoint types */
        .dag-legend-dot.checkpoint-before { background: #ffd60a; color: rgba(255, 214, 10, 0.6); }
        .dag-legend-dot.checkpoint-after { background: #30d158; color: rgba(48, 209, 88, 0.6); }
        .dag-legend-dot.checkpoint-error { background: #ff453a; color: rgba(255, 69, 58, 0.6); }
        .dag-legend-dot.diamond {
            border-radius: 2px;
            transform: rotate(45deg);
        }

        /* View toggle for DAG (Steps Only / Full Flow) */
        .dag-view-toggle {
            display: flex;
            gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px;
            border-radius: 6px;
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .dag-view-toggle .toggle-btn {
            padding: 5px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .dag-view-toggle .toggle-btn:hover:not(.active) {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 149, 0, 0.1);
        }
        .dag-view-toggle .toggle-btn.active {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.4) 0%, rgba(255, 149, 0, 0.2) 100%);
            border: 1px solid rgba(255, 149, 0, 0.6);
            color: #ffb84d;
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        /* Resizable divider between panels */
        .resize-handle {
            width: 6px;
            cursor: col-resize;
            background: transparent;
            position: relative;
            flex-shrink: 0;
            z-index: 10;
            transition: background 0.2s;
        }
        .resize-handle:hover,
        .resize-handle.active {
            background: rgba(10, 132, 255, 0.3);
        }
        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            transition: all 0.2s;
        }
        .resize-handle:hover::before,
        .resize-handle.active::before {
            background: var(--accent-blue);
            height: 60px;
        }
        /* Prevent text selection during resize */
        .resizing {
            user-select: none;
            cursor: col-resize !important;
        }
        .resizing * {
            cursor: col-resize !important;
        }

        .detail-panel {
            flex: 1;
            display: flex; flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            border-radius: 18px;
            border: 1px solid var(--glass-border-light);
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255,255,255,0.05);
            overflow: hidden;
        }

        .detail-header {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex; justify-content: space-between; align-items: center;
        }
        .detail-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .detail-tabs {
            display: flex; gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px; border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .detail-tab {
            padding: 5px 14px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .detail-tab:hover:not(.active) {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 149, 0, 0.1);
        }
        .detail-tab.active {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.4) 0%, rgba(255, 149, 0, 0.2) 100%);
            border: 1px solid rgba(255, 149, 0, 0.6);
            color: #ffb84d;
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .detail-content { flex: 1; overflow-y: auto; padding: 16px; }

        .empty-detail {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100%; color: var(--text-muted);
        }
        .empty-detail-icon { font-size: 56px; margin-bottom: 16px; opacity: 0.3; }

        .json-view {
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px; line-height: 1.7;
            white-space: pre-wrap; word-break: break-all;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px; border-radius: 14px;
            overflow-x: auto;
            border: 1px solid var(--border-subtle);
        }
        .json-key { color: var(--accent-teal); }
        .json-string { color: var(--accent-green); }
        .json-number { color: var(--accent-orange); }
        .json-boolean { color: var(--accent-purple); }
        .json-null { color: var(--text-muted); }

        .formatted-view { display: flex; flex-direction: column; gap: 18px; }

        .info-section {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 16px; padding: 20px;
            border: 1px solid var(--border-subtle);
        }
        .info-section-title {
            font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 16px; padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex; align-items: center; gap: 8px;
        }
        .info-section-title .section-icon { font-size: 14px; }
        .info-grid {
            display: grid;
            grid-template-columns: 130px 1fr;
            gap: 12px 20px;
        }
        .info-label { color: var(--text-muted); font-size: 13px; font-weight: 500; }
        .info-value { font-size: 13px; word-break: break-all; color: var(--text-primary); }
        .info-value.mono { font-family: 'SF Mono', 'Monaco', monospace; font-size: 12px; color: var(--text-secondary); }

        .capability-card {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 14px; padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s;
        }
        .capability-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .capability-name {
            font-weight: 600; font-size: 14px;
            margin-bottom: 8px; color: var(--accent-teal);
        }
        .capability-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6; }
        .capability-endpoint {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 11px; color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px; border-radius: 8px;
            display: inline-block;
        }
        .capability-params { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
        .param-tag {
            display: inline-block;
            padding: 4px 10px; border-radius: 8px;
            font-size: 11px; font-weight: 500;
        }
        .param-tag.required {
            background: rgba(255, 107, 107, 0.2);
            color: #ff8a8a;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .param-tag.optional {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
        }

        /* LLM Debug specific styles */
        .interaction-card {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s;
            overflow: hidden;
        }
        .interaction-card:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        .interaction-card.expanded {
            border-color: rgba(255, 255, 255, 0.15);
        }
        .interaction-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
        }
        .interaction-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .interaction-type-row { display: flex; align-items: center; gap: 12px; }
        .interaction-meta { display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); }
        .interaction-preview {
            font-size: 12px; color: var(--text-muted);
            margin-left: 12px; flex: 1;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 300px;
        }
        .expand-indicator {
            font-size: 12px; color: var(--text-muted);
            transition: transform 0.2s;
            margin-left: 12px;
        }
        .interaction-card.expanded .expand-indicator {
            transform: rotate(180deg);
        }
        .interaction-body {
            display: none;
            padding: 0 20px 20px 20px;
            border-top: 1px solid var(--border-subtle);
        }
        .interaction-card.expanded .interaction-body {
            display: block;
            padding-top: 16px;
        }
        .interaction-meta-item { display: flex; align-items: center; gap: 6px; }

        .prompt-section, .response-section {
            margin-bottom: 16px;
        }
        .prompt-label, .response-label {
            font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }
        .prompt-content, .response-content {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 12px; line-height: 1.6;
            background: rgba(0, 0, 0, 0.3);
            padding: 16px; border-radius: 10px;
            white-space: pre-wrap; word-break: break-word;
            max-height: 300px; overflow-y: auto;
            border: 1px solid var(--border-subtle);
        }
        .prompt-content { color: var(--accent-teal); }
        .response-content { color: var(--accent-green); }
        .error-content { color: var(--accent-red); }

        /* Inline copy button for prompt/response sections - matches .copy-btn style */
        .copy-inline-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
            backdrop-filter: blur(8px);
        }
        .copy-inline-btn:hover {
            background: rgba(10, 132, 255, 0.25);
            color: var(--text-primary);
            border-color: rgba(10, 132, 255, 0.4);
            box-shadow: 0 0 12px rgba(10, 132, 255, 0.2);
        }
        .copy-inline-btn.copied {
            background: rgba(50, 215, 75, 0.25);
            color: var(--text-primary);
            border-color: rgba(50, 215, 75, 0.4);
            box-shadow: 0 0 12px rgba(50, 215, 75, 0.2);
        }

        .token-stats {
            display: flex; gap: 16px; padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px; font-size: 12px;
        }
        .token-stat { display: flex; align-items: center; gap: 6px; color: var(--text-secondary); }
        .token-stat-value { font-weight: 600; color: var(--accent-orange); }

        .expand-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 11px; font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .expand-btn:hover { background: rgba(255, 255, 255, 0.12); color: var(--text-primary); }

        .json-container { position: relative; }
        .copy-btn {
            position: absolute; top: 14px; right: 14px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 12px; font-weight: 500;
            cursor: pointer;
            opacity: 0; transition: all 0.2s;
            backdrop-filter: blur(8px);
        }
        .json-container:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background: rgba(10, 132, 255, 0.25); color: var(--text-primary); border-color: rgba(10, 132, 255, 0.4); box-shadow: 0 0 12px rgba(10, 132, 255, 0.2); }
        .copy-btn.copied { background: rgba(50, 215, 75, 0.25); color: var(--text-primary); border-color: rgba(50, 215, 75, 0.4); box-shadow: 0 0 12px rgba(50, 215, 75, 0.2); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

        .error-banner {
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px; padding: 14px 18px;
            margin: 14px 18px;
            color: #ff8a8a; font-size: 13px;
            display: none;
        }
        .error-banner.visible { display: block; }

        .last-updated {
            padding: 12px 18px; font-size: 12px;
            color: var(--text-muted); font-weight: 500;
            border-top: 1px solid var(--border-subtle);
            text-align: right;
            background: rgba(0,0,0,0.2);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon">🧠</div>
                    <h1>Go<span>Mind</span> Registry</h1>
                </div>
                <div class="main-nav">
                    <button class="main-nav-btn active" data-view="registry" onclick="switchView('registry')">
                        <span class="nav-icon">📋</span> Registry
                    </button>
                    <button class="main-nav-btn" data-view="llm-debug" onclick="switchView('llm-debug')">
                        <span class="nav-icon">🔍</span> LLM Debug
                    </button>
                    <button class="main-nav-btn" data-view="hitl" onclick="switchView('hitl')">
                        <span class="nav-icon">✋</span> HITL Interrupted
                    </button>
                    <button class="main-nav-btn" data-view="dag" onclick="switchView('dag')">
                        <span class="nav-icon">🔀</span> Execution DAG
                    </button>
                </div>
            </div>
            <div class="header-controls">
                <div class="stats" id="registryStats">
                    <div class="stat"><span>Total</span><span class="stat-value total" id="totalCount">-</span></div>
                    <div class="stat"><span>Agents</span><span class="stat-value agents" id="agentCount">-</span></div>
                    <div class="stat"><span>Tools</span><span class="stat-value tools" id="toolCount">-</span></div>
                </div>
                <div class="stats hidden" id="llmDebugStats">
                    <div class="stat"><span>Records</span><span class="stat-value records" id="recordCount">-</span></div>
                    <div class="stat"><span>Total Tokens</span><span class="stat-value tokens" id="tokenCount">-</span></div>
                </div>
                <div class="stats hidden" id="hitlStats">
                    <div class="stat"><span>Pending</span><span class="stat-value" style="color: var(--accent-orange);" id="pendingCount">-</span></div>
                    <div class="stat"><span>Critical</span><span class="stat-value" style="color: var(--accent-red);" id="criticalCount">-</span></div>
                </div>
                <div class="stats hidden" id="dagStats">
                    <div class="stat"><span>Executions</span><span class="stat-value" style="color: var(--accent-teal);" id="executionCount">-</span></div>
                    <div class="stat"><span>Success Rate</span><span class="stat-value" style="color: var(--accent-green);" id="successRate">-</span></div>
                </div>
                <label class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked> Auto-refresh
                </label>
                <button class="refresh-btn" onclick="handleRefresh()">
                    <span class="refresh-icon">↻</span> Refresh
                </button>
            </div>
        </header>

        <div class="main" id="mainContainer">
            <!-- Registry View -->
            <div class="list-panel" id="registryListPanel">
                <div class="filters">
                    <div class="search-box">
                        <span class="search-icon">⌕</span>
                        <input type="text" id="searchInput" placeholder="Search services..." oninput="filterServices()">
                    </div>
                    <button class="filter-btn active" data-filter="all" onclick="setTypeFilter('all')">All</button>
                    <button class="filter-btn" data-filter="agent" onclick="setTypeFilter('agent')">Agents</button>
                    <button class="filter-btn" data-filter="tool" onclick="setTypeFilter('tool')">Tools</button>
                </div>
                <div class="error-banner" id="errorBanner">
                    <strong>Error:</strong> <span id="errorMessage"></span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Health</th>
                                <th>Last Seen</th>
                                <th>Capabilities</th>
                            </tr>
                        </thead>
                        <tbody id="serviceTableBody"></tbody>
                    </table>
                </div>
                <div class="last-updated" id="lastUpdated">Loading...</div>
            </div>

            <!-- Registry Resize Handle -->
            <div class="resize-handle" id="registryResizeHandle"></div>

            <!-- LLM Debug View -->
            <div class="list-panel hidden" id="llmDebugListPanel">
                <div class="filters">
                    <div class="search-box">
                        <span class="search-icon">⌕</span>
                        <input type="text" id="llmSearchInput" placeholder="Search by request ID, conversation ID, or type..." oninput="filterLLMRecords()">
                    </div>
                    <button class="filter-btn active" data-filter="all" onclick="setLLMTypeFilter('all')">All</button>
                    <button class="filter-btn" data-filter="success" onclick="setLLMTypeFilter('success')">Success</button>
                    <button class="filter-btn" data-filter="error" onclick="setLLMTypeFilter('error')">Errors</button>
                    <button class="filter-btn" data-filter="grouped" onclick="setLLMTypeFilter('grouped')" title="Group related HITL records by conversation">Grouped</button>
                </div>
                <div class="error-banner" id="llmErrorBanner">
                    <strong>Error:</strong> <span id="llmErrorMessage"></span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>Conversation</th>
                                <th>Interactions</th>
                                <th>Tokens</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="llmTableBody"></tbody>
                    </table>
                </div>
                <div class="last-updated" id="llmLastUpdated">Loading...</div>
            </div>

            <!-- Resize Handle for LLM Debug View -->
            <div class="resize-handle hidden" id="llmResizeHandle"></div>

            <!-- HITL List Panel -->
            <div class="list-panel hidden" id="hitlListPanel">
                <div class="filters">
                    <div class="search-box">
                        <span class="search-icon">⌕</span>
                        <input type="text" id="hitlSearchInput" placeholder="Search by checkpoint ID, request, or message..." oninput="filterHITLCheckpoints()">
                    </div>
                    <button class="filter-btn active" data-filter="all" onclick="setHITLTypeFilter('all')">All</button>
                    <button class="filter-btn" data-filter="plan" onclick="setHITLTypeFilter('plan')">Plan</button>
                    <button class="filter-btn" data-filter="step" onclick="setHITLTypeFilter('step')">Step</button>
                    <button class="filter-btn" data-filter="error" onclick="setHITLTypeFilter('error')">Error</button>
                </div>
                <div class="error-banner" id="hitlErrorBanner">
                    <strong>Error:</strong> <span id="hitlErrorMessage"></span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th class="sortable" data-sort="agent_name" onclick="sortHITLTable('agent_name')">Agent</th>
                                <th>Type</th>
                                <th>Request</th>
                                <th>Progress</th>
                                <th class="sortable" data-sort="created_at" onclick="sortHITLTable('created_at')">Created</th>
                                <th class="sortable asc" data-sort="expires_at" onclick="sortHITLTable('expires_at')">Expires</th>
                            </tr>
                        </thead>
                        <tbody id="hitlTableBody"></tbody>
                    </table>
                </div>
                <div class="last-updated" id="hitlLastUpdated">Loading...</div>
            </div>

            <!-- HITL Resize Handle -->
            <div class="resize-handle hidden" id="hitlResizeHandle"></div>

            <!-- Registry Detail Panel -->
            <div class="detail-panel" id="registryDetailPanel">
                <div class="detail-header">
                    <span class="detail-title" id="detailTitle">Select a service</span>
                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="formatted" onclick="setDetailTab('formatted')">Formatted</button>
                        <button class="detail-tab" data-tab="json" onclick="setDetailTab('json')">JSON</button>
                    </div>
                </div>
                <div class="detail-content" id="detailContent">
                    <div class="empty-detail">
                        <div class="empty-detail-icon">📋</div>
                        <div>Select a service to view details</div>
                    </div>
                </div>
            </div>

            <!-- LLM Debug Detail Panel -->
            <div class="detail-panel hidden" id="llmDebugDetailPanel">
                <div class="detail-header">
                    <span class="detail-title" id="llmDetailTitle">Select a record</span>
                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="interactions" onclick="setLLMDetailTab('interactions')">Interactions</button>
                        <button class="detail-tab" data-tab="json" onclick="setLLMDetailTab('json')">JSON</button>
                    </div>
                </div>
                <div class="detail-content" id="llmDetailContent">
                    <div class="empty-detail">
                        <div class="empty-detail-icon">🔍</div>
                        <div>Select a record to view LLM interactions</div>
                    </div>
                </div>
            </div>

            <!-- HITL Detail Panel -->
            <div class="detail-panel hidden" id="hitlDetailPanel">
                <div class="detail-header">
                    <span class="detail-title" id="hitlDetailTitle">Select a checkpoint</span>
                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="overview" onclick="setHITLDetailTab('overview')">Overview</button>
                        <button class="detail-tab" data-tab="plan" onclick="setHITLDetailTab('plan')">Plan</button>
                        <button class="detail-tab" data-tab="json" onclick="setHITLDetailTab('json')">JSON</button>
                    </div>
                </div>
                <div class="detail-content" id="hitlDetailContent">
                    <div class="empty-detail">
                        <div class="empty-detail-icon">✋</div>
                        <div>Select a checkpoint to view details</div>
                    </div>
                </div>
            </div>

            <!-- Execution DAG View -->
            <div class="list-panel hidden" id="dagListPanel">
                <div class="filters">
                    <div class="search-box">
                        <span class="search-icon">⌕</span>
                        <input type="text" id="dagSearchInput" placeholder="Search by request ID or query..." oninput="filterExecutions()">
                    </div>
                    <button class="filter-btn active" data-filter="all" onclick="setDagFilter('all')">All</button>
                    <button class="filter-btn" data-filter="success" onclick="setDagFilter('success')">Success</button>
                    <button class="filter-btn" data-filter="failed" onclick="setDagFilter('failed')">Failed</button>
                    <button class="filter-btn" data-filter="interrupted" onclick="setDagFilter('interrupted')">Interrupted</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th class="sortable" data-sort="original_request" onclick="sortDagTable('original_request')">Request</th>
                                <th>Steps</th>
                                <th class="sortable" data-sort="total_duration_ms" onclick="sortDagTable('total_duration_ms')">Duration</th>
                                <th class="sortable desc" data-sort="created_at" onclick="sortDagTable('created_at')">Created</th>
                            </tr>
                        </thead>
                        <tbody id="dagTableBody"></tbody>
                    </table>
                </div>
                <div class="last-updated" id="dagLastUpdated">Loading...</div>
            </div>
            <div class="resize-handle hidden" id="dagResizeHandle"></div>
            <div class="detail-panel hidden" id="dagDetailPanel">
                <div class="detail-header">
                    <span class="detail-title" id="dagDetailTitle">Select an execution</span>
                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="dag-viz" onclick="setDagDetailTab('dag-viz')">DAG Visualization</button>
                        <button class="detail-tab" data-tab="dag-steps" onclick="setDagDetailTab('dag-steps')">Step Details</button>
                        <button class="detail-tab" data-tab="dag-llm" onclick="setDagDetailTab('dag-llm')" style="display: none;">LLM Calls</button>
                        <button class="detail-tab" data-tab="dag-hitl" onclick="setDagDetailTab('dag-hitl')" style="display: none;">HITL</button>
                        <button class="detail-tab" data-tab="dag-raw" onclick="setDagDetailTab('dag-raw')">Raw JSON</button>
                    </div>
                </div>
                <div class="detail-content" id="dagDetailContent">
                    <div class="empty-detail">
                        <div class="empty-detail-icon">🔀</div>
                        <div>Select an execution to view DAG</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cytoscape.js for DAG visualization -->
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script>
        // ==================== State ====================
        let currentView = 'registry';
        let allServices = [];
        let selectedService = null;
        let currentTab = 'formatted';
        let currentTypeFilter = 'all';

        let allLLMRecords = [];
        let selectedLLMRecord = null;
        let currentLLMTab = 'interactions';
        let currentLLMTypeFilter = 'all';
        let expandedInteractions = new Set(); // Track which interactions are expanded

        let allHITLCheckpoints = [];
        let selectedHITLCheckpoint = null;
        let currentHITLTab = 'overview';
        let currentHITLTypeFilter = 'all';
        let hitlSortColumn = 'expires_at';  // Default sort column
        let hitlSortDirection = 'asc';      // Default sort direction

        let allExecutions = [];
        let selectedExecution = null;
        let currentDagTab = 'dag-viz';
        let currentDagFilter = 'all';
        let cyInstance = null; // Cytoscape instance
        let dagViewMode = 'full'; // 'steps' or 'full' - controls DAG visualization mode (default: full)
        let dagSortColumn = 'created_at';  // Default sort column
        let dagSortDirection = 'desc';     // Default sort direction (newest first, descending)

        let autoRefreshInterval = null;

        // ==================== View Switching ====================
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.main-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Toggle layout class for different views
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.classList.remove('llm-debug-view', 'hitl-view', 'dag-view');
            if (view === 'llm-debug') mainContainer.classList.add('llm-debug-view');
            if (view === 'hitl') mainContainer.classList.add('hitl-view');
            if (view === 'dag') mainContainer.classList.add('dag-view');

            // Toggle panels
            document.getElementById('registryListPanel').classList.toggle('hidden', view !== 'registry');
            document.getElementById('registryDetailPanel').classList.toggle('hidden', view !== 'registry');
            document.getElementById('registryResizeHandle').classList.toggle('hidden', view !== 'registry');
            document.getElementById('llmDebugListPanel').classList.toggle('hidden', view !== 'llm-debug');
            document.getElementById('llmDebugDetailPanel').classList.toggle('hidden', view !== 'llm-debug');
            document.getElementById('llmResizeHandle').classList.toggle('hidden', view !== 'llm-debug');
            document.getElementById('hitlListPanel').classList.toggle('hidden', view !== 'hitl');
            document.getElementById('hitlDetailPanel').classList.toggle('hidden', view !== 'hitl');
            document.getElementById('hitlResizeHandle').classList.toggle('hidden', view !== 'hitl');
            document.getElementById('dagListPanel').classList.toggle('hidden', view !== 'dag');
            document.getElementById('dagDetailPanel').classList.toggle('hidden', view !== 'dag');
            document.getElementById('dagResizeHandle').classList.toggle('hidden', view !== 'dag');

            // Toggle stats
            document.getElementById('registryStats').classList.toggle('hidden', view !== 'registry');
            document.getElementById('llmDebugStats').classList.toggle('hidden', view !== 'llm-debug');
            document.getElementById('hitlStats').classList.toggle('hidden', view !== 'hitl');
            document.getElementById('dagStats').classList.toggle('hidden', view !== 'dag');

            // Handle auto-refresh and data fetching
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (view === 'llm-debug') {
                autoRefreshCheckbox.checked = false;
                updateAutoRefresh();
                fetchLLMRecords();
            } else if (view === 'hitl') {
                // Keep auto-refresh enabled for HITL - pending approvals are time-sensitive
                fetchHITLCheckpoints();
            } else if (view === 'dag') {
                fetchExecutions();
            } else {
                fetchServices();
            }
        }

        function handleRefresh() {
            if (currentView === 'registry') {
                fetchServices();
            } else if (currentView === 'llm-debug') {
                fetchLLMRecords();
            } else if (currentView === 'hitl') {
                fetchHITLCheckpoints();
            } else if (currentView === 'dag') {
                fetchExecutions();
            }
        }

        // ==================== Utility Functions ====================
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 5) return 'just now';
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        function formatDateTime(date) {
            return new Date(date).toLocaleString();
        }

        function formatDuration(ms) {
            if (ms < 1000) return `${ms}ms`;
            return `${(ms / 1000).toFixed(2)}s`;
        }

        function formatTokens(count) {
            if (count >= 1000) return `${(count / 1000).toFixed(1)}k`;
            return count.toString();
        }

        function syntaxHighlightJson(json) {
            if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
            // Trim any leading/trailing whitespace to prevent layout issues
            json = json.trim();
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                        match = match.slice(0, -1) + '</span>:';
                        return '<span class="' + cls + '">' + match;
                    } else { cls = 'json-string'; }
                } else if (/true|false/.test(match)) { cls = 'json-boolean'; }
                else if (/null/.test(match)) { cls = 'json-null'; }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function truncateText(text, maxLength = 100) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function copyToClipboard(text, evt) {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief feedback with glassy green effect
                const btn = evt?.target || evt;
                if (!btn) return;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 1500);
            }).catch(err => console.error('Copy failed:', err));
        }

        // ==================== Registry Functions ====================
        function setTypeFilter(filter) {
            currentTypeFilter = filter;
            document.querySelectorAll('#registryListPanel .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterServices();
        }

        function filterServices() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allServices.filter(service => {
                const matchesType = currentTypeFilter === 'all' || service.type === currentTypeFilter;
                const matchesSearch = !searchTerm ||
                    service.name.toLowerCase().includes(searchTerm) ||
                    service.id.toLowerCase().includes(searchTerm) ||
                    (service.description && service.description.toLowerCase().includes(searchTerm));
                return matchesType && matchesSearch;
            });
            renderServiceTable(filtered);
        }

        function renderServiceTable(services) {
            const tbody = document.getElementById('serviceTableBody');
            if (services.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 48px;">No services found</td></tr>`;
                return;
            }
            tbody.innerHTML = services.map(service => `
                <tr onclick="selectService('${service.id}')" class="${selectedService?.id === service.id ? 'selected' : ''}">
                    <td><span class="type-badge ${service.type}">${service.type}</span></td>
                    <td><span class="service-name">${service.name}</span></td>
                    <td><div class="health-indicator"><span class="health-dot ${service.health || 'unknown'}"></span>${service.health || 'unknown'}</div></td>
                    <td><span class="time-ago">${formatTimeAgo(service.lastSeen || service.last_seen)}</span></td>
                    <td>${service.capabilities?.length || 0}</td>
                </tr>
            `).join('');
        }

        function selectService(serviceId) {
            selectedService = allServices.find(s => s.id === serviceId);
            filterServices();
            renderDetail();
        }

        function setDetailTab(tab) {
            currentTab = tab;
            document.querySelectorAll('#registryDetailPanel .detail-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            renderDetail();
        }

        function renderDetail() {
            const content = document.getElementById('detailContent');
            const title = document.getElementById('detailTitle');
            if (!selectedService) {
                title.textContent = 'Select a service';
                content.innerHTML = `<div class="empty-detail"><div class="empty-detail-icon">📋</div><div>Select a service to view details</div></div>`;
                return;
            }
            title.textContent = selectedService.name;
            if (currentTab === 'json') {
                content.innerHTML = `<div class="json-container"><button class="copy-btn" onclick="copyJson(event)">Copy</button><pre class="json-view">${syntaxHighlightJson(selectedService)}</pre></div>`;
            } else {
                content.innerHTML = renderFormattedView(selectedService);
            }
        }

        function renderFormattedView(service) {
            const lastSeen = service.lastSeen || service.last_seen;
            let html = `<div class="formatted-view">`;

            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">ℹ️</span> Service Info</div><div class="info-grid">
                <div class="info-label">ID</div><div class="info-value mono">${service.id}</div>
                <div class="info-label">Name</div><div class="info-value">${service.name}</div>
                <div class="info-label">Type</div><div class="info-value"><span class="type-badge ${service.type}">${service.type}</span></div>
                <div class="info-label">Health</div><div class="info-value"><div class="health-indicator"><span class="health-dot ${service.health || 'unknown'}"></span>${service.health || 'unknown'}</div></div>
                <div class="info-label">Last Seen</div><div class="info-value">${lastSeen ? formatDateTime(lastSeen) : 'N/A'}</div>
                ${service.description ? `<div class="info-label">Description</div><div class="info-value">${service.description}</div>` : ''}
            </div></div>`;

            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">🌐</span> Network</div><div class="info-grid">
                <div class="info-label">Address</div><div class="info-value mono">${service.address}:${service.port}</div>
            </div></div>`;

            if (service.metadata && Object.keys(service.metadata).length > 0) {
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">🏷️</span> Metadata</div><div class="info-grid">
                    ${Object.entries(service.metadata).map(([key, value]) => `<div class="info-label">${key}</div><div class="info-value mono">${value}</div>`).join('')}
                </div></div>`;
            }

            if (service.capabilities && service.capabilities.length > 0) {
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">⚡</span> Capabilities (${service.capabilities.length})</div>
                    ${service.capabilities.map((cap, idx) => `<div class="capability-card">
                        <div class="capability-name">${cap.name}</div>
                        ${cap.description ? `<div class="capability-desc">${cap.description}</div>` : ''}
                        ${cap.endpoint ? `<div class="capability-endpoint">${cap.endpoint}</div>` : ''}
                        ${cap.input_summary ? `<div class="capability-params">
                            ${(cap.input_summary.required || []).map(p => `<span class="param-tag required">${p.name}: ${p.type}</span>`).join('')}
                            ${(cap.input_summary.optional || []).map(p => `<span class="param-tag optional">${p.name}?: ${p.type}</span>`).join('')}
                        </div>` : ''}
                        <div class="dag-step-response-header" onclick="toggleCapabilityJson('cap-json-${idx}')" style="margin-top: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 12px; color: var(--text-secondary);">
                            <span><span class="expand-arrow" id="cap-arrow-${idx}">▶</span> View Full JSON</span>
                            <span style="color: var(--text-muted);">Click to expand</span>
                        </div>
                        <div id="cap-json-${idx}" class="dag-step-response-content" style="display: none; margin-top: 8px;">${formatResponseJson(cap)}</div>
                    </div>`).join('')}
                </div>`;
            }

            html += `</div>`;
            return html;
        }

        function copyJson(evt) {
            const text = JSON.stringify(selectedService, null, 2);
            copyToClipboard(text, evt);
        }

        async function fetchServices() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const errorBanner = document.getElementById('errorBanner');
            refreshBtn.classList.add('loading');

            try {
                const response = await fetch('/api/services');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const data = await response.json();

                document.getElementById('totalCount').textContent = data.totalCount;
                document.getElementById('agentCount').textContent = data.agentCount;
                document.getElementById('toolCount').textContent = data.toolCount;

                allServices = data.services.sort((a, b) => {
                    if (a.type !== b.type) return a.type === 'agent' ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });

                filterServices();

                if (selectedService) {
                    const updated = allServices.find(s => s.id === selectedService.id);
                    if (updated) { selectedService = updated; renderDetail(); }
                }

                document.getElementById('lastUpdated').textContent = `Last updated: ${formatDateTime(data.timestamp)}`;
                errorBanner.classList.remove('visible');
            } catch (error) {
                console.error('Failed to fetch services:', error);
                document.getElementById('errorMessage').textContent = error.message;
                errorBanner.classList.add('visible');
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // ==================== LLM Debug Functions ====================
        function setLLMTypeFilter(filter) {
            currentLLMTypeFilter = filter;
            document.querySelectorAll('#llmDebugListPanel .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterLLMRecords();
        }

        // Active conversation filter (when user clicks on a conversation ID)
        let activeConversationFilter = null;

        function filterLLMRecords() {
            const searchTerm = document.getElementById('llmSearchInput').value.toLowerCase();
            let filtered = allLLMRecords.filter(record => {
                // Support both summary format (has_errors) and full format (interactions)
                const hasErrors = record.has_errors !== undefined ? record.has_errors :
                    (record.interactions ? record.interactions.some(i => !i.success) : false);
                const origReqId = record.original_request_id || record.request_id;

                // Check conversation filter first
                if (activeConversationFilter && origReqId !== activeConversationFilter) {
                    return false;
                }

                const matchesFilter = currentLLMTypeFilter === 'all' ||
                    currentLLMTypeFilter === 'grouped' || // grouped mode shows all, but sorted
                    (currentLLMTypeFilter === 'success' && !hasErrors) ||
                    (currentLLMTypeFilter === 'error' && hasErrors);
                const matchesSearch = !searchTerm ||
                    record.request_id.toLowerCase().includes(searchTerm) ||
                    (origReqId && origReqId.toLowerCase().includes(searchTerm)) ||
                    (record.trace_id && record.trace_id.toLowerCase().includes(searchTerm));
                return matchesFilter && matchesSearch;
            });

            // In grouped mode, sort by original_request_id then by created_at
            if (currentLLMTypeFilter === 'grouped') {
                filtered.sort((a, b) => {
                    const origA = a.original_request_id || a.request_id;
                    const origB = b.original_request_id || b.request_id;
                    if (origA !== origB) return origA.localeCompare(origB);
                    return new Date(a.created_at) - new Date(b.created_at);
                });
            }

            renderLLMTable(filtered);
        }

        // Count how many records share the same conversation/original_request_id
        function countLinkedRecords(conversationId) {
            return allLLMRecords.filter(r => {
                const origReqId = r.original_request_id || r.request_id;
                return origReqId === conversationId;
            }).length;
        }

        // Filter to show only records from a specific HITL conversation
        function filterByConversation(conversationId) {
            // Don't allow filtering if there's only one record with this conversation ID
            const linkedCount = countLinkedRecords(conversationId);
            if (linkedCount <= 1 && activeConversationFilter !== conversationId) {
                // No linked records to filter - do nothing
                return;
            }

            if (activeConversationFilter === conversationId) {
                // Toggle off - clear the filter
                activeConversationFilter = null;
                document.getElementById('llmSearchInput').placeholder = 'Search by request ID, conversation ID, or type...';
            } else {
                activeConversationFilter = conversationId;
                document.getElementById('llmSearchInput').placeholder = `Filtering by conversation: ${truncateText(conversationId, 16)} (click again to clear)`;
            }
            filterLLMRecords();
        }

        function renderLLMTable(records) {
            const tbody = document.getElementById('llmTableBody');
            if (records.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 48px;">No LLM debug records found</td></tr>`;
                return;
            }
            tbody.innerHTML = records.map(record => {
                // Support both summary format and full format
                const totalTokens = record.total_tokens !== undefined ? record.total_tokens :
                    (record.interactions ? record.interactions.reduce((sum, i) => sum + (i.total_tokens || 0), 0) : 0);
                const hasErrors = record.has_errors !== undefined ? record.has_errors :
                    (record.interactions ? record.interactions.some(i => !i.success) : false);
                const interactionCount = record.interaction_count !== undefined ? record.interaction_count :
                    (record.interactions ? record.interactions.length : 0);
                // Original request ID links related HITL records
                const origReqId = record.original_request_id || record.request_id;
                const isResumed = origReqId !== record.request_id;
                // Check if this conversation has linked records (makes it clickable)
                const hasLinkedRecords = countLinkedRecords(origReqId) > 1;
                return `
                <tr onclick="selectLLMRecord('${record.request_id}')" class="${selectedLLMRecord?.request_id === record.request_id ? 'selected' : ''}">
                    <td><span class="request-id" title="${record.request_id}">${record.request_id}</span></td>
                    <td>
                        <span class="request-id" title="${origReqId}${hasLinkedRecords ? ' (click to filter linked records)' : ''}" style="${hasLinkedRecords ? 'cursor: pointer; text-decoration: underline; text-decoration-style: dotted;' : ''}" ${hasLinkedRecords ? `onclick="event.stopPropagation(); filterByConversation('${origReqId}')"` : ''}>
                            ${isResumed ? '🔗 ' : ''}${origReqId}
                        </span>
                    </td>
                    <td>${interactionCount}</td>
                    <td>${formatTokens(totalTokens)}</td>
                    <td><span class="status-badge ${hasErrors ? 'error' : 'success'}">${hasErrors ? '⚠ Has Errors' : '✓ Success'}</span></td>
                    <td><span class="time-ago">${formatTimeAgo(record.created_at)}</span></td>
                </tr>
            `}).join('');
        }

        async function selectLLMRecord(requestId) {
            // Clear expanded state when switching to a different record
            if (!selectedLLMRecord || selectedLLMRecord.request_id !== requestId) {
                expandedInteractions.clear();
            }

            // Check if we already have the full record (with interactions)
            const summaryRecord = allLLMRecords.find(r => r.request_id === requestId);
            if (summaryRecord && summaryRecord.interactions) {
                // Already have full record (from mock data)
                selectedLLMRecord = summaryRecord;
            } else {
                // Need to fetch full record from API
                try {
                    const response = await fetch(`/api/llm-debug/${encodeURIComponent(requestId)}`);
                    if (response.ok) {
                        selectedLLMRecord = await response.json();
                    } else if (summaryRecord) {
                        // API failed, but we have summary - show what we can
                        selectedLLMRecord = summaryRecord;
                    } else {
                        selectedLLMRecord = null;
                    }
                } catch (error) {
                    console.error('Failed to fetch LLM record:', error);
                    // Fallback to mock if available
                    const mockRecord = getMockLLMDebugRecord(requestId);
                    selectedLLMRecord = mockRecord || summaryRecord || null;
                }
            }

            filterLLMRecords();
            renderLLMDetail();
        }

        // Helper to get mock record by ID (for fallback)
        function getMockLLMDebugRecord(requestId) {
            const mockData = getMockLLMDebugData();
            return mockData.records.find(r => r.request_id === requestId) || null;
        }

        function setLLMDetailTab(tab) {
            currentLLMTab = tab;
            document.querySelectorAll('#llmDebugDetailPanel .detail-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            renderLLMDetail();
        }

        function renderLLMDetail() {
            const content = document.getElementById('llmDetailContent');
            const title = document.getElementById('llmDetailTitle');
            if (!selectedLLMRecord) {
                title.textContent = 'Select a record';
                content.innerHTML = `<div class="empty-detail"><div class="empty-detail-icon">🔍</div><div>Select a record to view LLM interactions</div></div>`;
                return;
            }
            title.textContent = `Request: ${truncateText(selectedLLMRecord.request_id, 30)}`;
            if (currentLLMTab === 'json') {
                content.innerHTML = `<div class="json-container"><button class="copy-btn" onclick="copyLLMJson(event)">Copy</button><pre class="json-view">${syntaxHighlightJson(selectedLLMRecord)}</pre></div>`;
            } else {
                content.innerHTML = renderLLMInteractionsView(selectedLLMRecord);
            }
        }

        function renderLLMInteractionsView(record) {
            let html = `<div class="formatted-view">`;

            // Handle case where we only have summary data (no interactions)
            const interactions = record.interactions || [];

            // Extract unique models and providers from interactions
            const models = [...new Set(interactions.map(i => i.model).filter(Boolean))];
            const providers = [...new Set(interactions.map(i => i.provider).filter(Boolean))];

            // Interaction count - support both summary and full format
            const interactionCount = record.interaction_count !== undefined ? record.interaction_count : interactions.length;

            // Determine if this is a resumed request
            const origReqId = record.original_request_id || record.request_id;
            const isResumed = origReqId !== record.request_id;
            // Check if this conversation has linked records
            const hasLinkedRecords = countLinkedRecords(origReqId) > 1;

            // Record Info
            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">📊</span> Record Info</div><div class="info-grid">
                <div class="info-label">Request ID</div><div class="info-value mono">${record.request_id}</div>
                <div class="info-label">Conversation ID</div><div class="info-value mono" style="display: flex; align-items: center; gap: 8px;">
                    ${isResumed ? '<span title="This is a resumed HITL request">🔗</span>' : ''}
                    <span style="${hasLinkedRecords ? 'cursor: pointer; text-decoration: underline; text-decoration-style: dotted;' : ''}" ${hasLinkedRecords ? `onclick="filterByConversation('${origReqId}')" title="Click to filter linked records (${countLinkedRecords(origReqId)} total)"` : ''}>${origReqId}</span>
                    ${isResumed ? '<span style="font-size: 11px; color: var(--text-muted);">(HITL resume)</span>' : ''}
                </div>
                ${record.trace_id ? `<div class="info-label">Trace ID</div><div class="info-value mono">${record.trace_id}</div>` : ''}
                <div class="info-label">Created</div><div class="info-value">${formatDateTime(record.created_at)}</div>
                <div class="info-label">Interactions</div><div class="info-value">${interactionCount}</div>
                ${models.length > 0 ? `<div class="info-label">Model${models.length > 1 ? 's' : ''}</div><div class="info-value">${models.join(', ')}</div>` : ''}
                ${providers.length > 0 ? `<div class="info-label">Provider${providers.length > 1 ? 's' : ''}</div><div class="info-value">${providers.join(', ')}</div>` : ''}
            </div></div>`;

            // Show message if no interactions available
            if (interactions.length === 0) {
                html += `<div class="info-section">
                    <div class="info-section-title"><span class="section-icon">💬</span> LLM Interactions</div>
                    <div style="padding: 24px; text-align: center; color: var(--text-muted);">
                        Loading interaction details...
                    </div>
                </div></div>`;
                return html;
            }

            // Interactions
            html += `<div class="info-section">
                <div class="info-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span><span class="section-icon">💬</span> LLM Interactions (${interactions.length})</span>
                    <span style="display: flex; gap: 8px;">
                        <button class="expand-btn" onclick="expandAllInteractions()">Expand All</button>
                        <button class="expand-btn" onclick="collapseAllInteractions()">Collapse All</button>
                    </span>
                </div>`;

            interactions.forEach((interaction, index) => {
                const promptPreview = truncateText(interaction.prompt, 60);
                const isExpanded = expandedInteractions.has(index);
                html += `<div class="interaction-card${isExpanded ? ' expanded' : ''}" id="interaction-${index}">
                    <div class="interaction-header" onclick="toggleInteraction(${index})">
                        <div class="interaction-type-row">
                            <span class="type-badge ${interaction.type}">${interaction.type.replace('_', ' ')}</span>
                            <span class="status-badge ${interaction.success ? 'success' : 'error'}">${interaction.success ? '✓' : '✗'}</span>
                            ${interaction.step_id ? `<span class="step-id-badge" title="Associated with step">📍 ${interaction.step_id}</span>` : ''}
                            <span class="interaction-preview">${escapeHtml(promptPreview)}</span>
                        </div>
                        <div class="interaction-meta">
                            ${interaction.model ? `<div class="interaction-meta-item">🤖 ${interaction.model}</div>` : ''}
                            <div class="interaction-meta-item">⏱️ ${formatDuration(interaction.duration_ms)}</div>
                            ${interaction.total_tokens ? `<div class="interaction-meta-item" title="Input / Output tokens">🎫 ${formatTokens(interaction.prompt_tokens || 0)} / ${formatTokens(interaction.completion_tokens || 0)}</div>` : ''}
                            ${interaction.attempt > 1 ? `<div class="interaction-meta-item">🔄 #${interaction.attempt}</div>` : ''}
                            <span class="expand-indicator">▼</span>
                        </div>
                    </div>
                    <div class="interaction-body">
                        <div class="prompt-section">
                            <div class="prompt-label">📥 Prompt <button class="copy-inline-btn" onclick="event.stopPropagation(); copyLLMInteractionContent(${index}, 'prompt', event)">Copy</button></div>
                            <div class="prompt-content">${escapeHtml(interaction.prompt)}</div>
                        </div>

                        ${interaction.success ? `
                        <div class="response-section">
                            <div class="response-label">📤 Response <button class="copy-inline-btn" onclick="event.stopPropagation(); copyLLMInteractionContent(${index}, 'response', event)">Copy</button></div>
                            <div class="response-content">${escapeHtml(interaction.response)}</div>
                        </div>

                        <div class="token-stats">
                            ${interaction.model ? `<div class="token-stat">Model: <span class="token-stat-value">${interaction.model}</span></div>` : ''}
                            ${interaction.provider ? (() => {
                                const provider = interaction.provider.toLowerCase();
                                const providerColors = {
                                    'openai': { bg: 'rgba(16, 163, 127, 0.2)', border: 'rgba(16, 163, 127, 0.4)', color: '#10a37f' },
                                    'anthropic': { bg: 'rgba(204, 153, 102, 0.2)', border: 'rgba(204, 153, 102, 0.4)', color: '#cc9966' },
                                    'groq': { bg: 'rgba(255, 140, 0, 0.2)', border: 'rgba(255, 140, 0, 0.4)', color: '#ff8c00' },
                                    'gemini': { bg: 'rgba(66, 133, 244, 0.2)', border: 'rgba(66, 133, 244, 0.4)', color: '#4285f4' },
                                    'deepseek': { bg: 'rgba(0, 122, 255, 0.2)', border: 'rgba(0, 122, 255, 0.4)', color: '#007aff' },
                                    'default': { bg: 'rgba(150, 150, 150, 0.2)', border: 'rgba(150, 150, 150, 0.4)', color: '#aaaaaa' }
                                };
                                const colors = providerColors[provider] || providerColors['default'];
                                return `<div class="token-stat">Provider: <span style="
                                    display: inline-block;
                                    padding: 2px 10px;
                                    background: linear-gradient(135deg, ${colors.bg} 0%, rgba(255,255,255,0.05) 100%);
                                    border: 1px solid ${colors.border};
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    color: ${colors.color};
                                    letter-spacing: 0.3px;
                                ">${interaction.provider}</span></div>`;
                            })() : ''}
                            <div class="token-stat">Prompt: <span class="token-stat-value">${interaction.prompt_tokens || 0}</span></div>
                            <div class="token-stat">Completion: <span class="token-stat-value">${interaction.completion_tokens || 0}</span></div>
                            <div class="token-stat">Total: <span class="token-stat-value">${interaction.total_tokens || 0}</span></div>
                        </div>
                        ` : `
                        <div class="response-section">
                            <div class="response-label">❌ Error</div>
                            <div class="prompt-content error-content">${escapeHtml(interaction.error || 'Unknown error')}</div>
                        </div>
                        `}
                    </div>
                </div>`;
            });

            html += `</div></div>`;
            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format conversation request with highlighted labels for "Previous conversation:" and "Current request:"
        function formatConversationRequest(text) {
            if (!text) return '';

            // Style for "Previous conversation:" label - muted blue/slate glassy (compact)
            const prevStyle = 'display: inline-block; padding: 1px 5px; margin-right: 3px; ' +
                'background: linear-gradient(135deg, rgba(99, 110, 143, 0.3) 0%, rgba(99, 110, 143, 0.15) 100%); ' +
                'border: 1px solid rgba(99, 110, 143, 0.5); border-radius: 3px; ' +
                'font-size: 10px; font-weight: 600; color: #8b95b3; letter-spacing: 0.2px; vertical-align: middle;';

            // Style for "Current request:" label - vibrant teal/cyan glassy (compact)
            const currStyle = 'display: inline-block; padding: 1px 5px; margin-right: 3px; ' +
                'background: linear-gradient(135deg, rgba(0, 210, 211, 0.25) 0%, rgba(0, 210, 211, 0.12) 100%); ' +
                'border: 1px solid rgba(0, 210, 211, 0.5); border-radius: 3px; ' +
                'font-size: 10px; font-weight: 600; color: #00d2d3; letter-spacing: 0.2px; vertical-align: middle;';

            // Escape the text first
            let escaped = escapeHtml(text);

            // Replace the labels with styled versions
            escaped = escaped.replace(
                /Previous conversation:/g,
                '<span style="' + prevStyle + '">Previous conversation:</span>'
            );
            escaped = escaped.replace(
                /Current request:/g,
                '<span style="' + currStyle + '">Current request:</span>'
            );

            return escaped;
        }

        // Parse and format JSON response - handles both string and object formats
        function formatJsonResponse(response) {
            if (!response) return '';
            try {
                // If it's a string, try to parse it as JSON
                const parsed = typeof response === 'string' ? JSON.parse(response) : response;
                return JSON.stringify(parsed, null, 2);
            } catch (e) {
                // If parsing fails, return the original (escaped for safety)
                return typeof response === 'string' ? response : JSON.stringify(response);
            }
        }

        function copyLLMJson(evt) {
            const text = JSON.stringify(selectedLLMRecord, null, 2);
            copyToClipboard(text, evt);
        }

        // Copy prompt or response from LLM Debug tab interaction
        function copyLLMInteractionContent(index, type, evt) {
            if (!selectedLLMRecord?.interactions?.[index]) return;
            const interaction = selectedLLMRecord.interactions[index];
            const text = type === 'prompt' ? interaction.prompt : interaction.response;
            copyTextWithFeedback(text, evt?.target || evt);
        }

        // Copy prompt or response from DAG LLM Calls sub-tab
        function copyDAGLLMContent(index, type, evt) {
            if (!selectedExecution?.llm_interactions?.[index]) return;
            const interaction = selectedExecution.llm_interactions[index];
            const text = type === 'prompt' ? interaction.prompt : interaction.response;
            copyTextWithFeedback(text, evt?.target || evt);
        }

        // Helper function to copy text and show feedback on button
        function copyTextWithFeedback(text, btn) {
            if (!text || !btn) return;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 1500);
            }).catch(err => console.error('Copy failed:', err));
        }

        function toggleInteraction(index) {
            const card = document.getElementById(`interaction-${index}`);
            if (card) {
                card.classList.toggle('expanded');
                // Track the state
                if (card.classList.contains('expanded')) {
                    expandedInteractions.add(index);
                } else {
                    expandedInteractions.delete(index);
                }
            }
        }

        function expandAllInteractions() {
            document.querySelectorAll('.interaction-card').forEach((card, index) => {
                card.classList.add('expanded');
                expandedInteractions.add(index);
            });
        }

        function collapseAllInteractions() {
            document.querySelectorAll('.interaction-card').forEach(card => {
                card.classList.remove('expanded');
            });
            expandedInteractions.clear();
        }

        async function fetchLLMRecords() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const errorBanner = document.getElementById('llmErrorBanner');
            refreshBtn.classList.add('loading');

            try {
                // Try to fetch from API, fallback to mock data
                let data;
                let isFromAPI = false;
                try {
                    const response = await fetch('/api/llm-debug');
                    if (response.ok) {
                        data = await response.json();
                        isFromAPI = true;
                    } else {
                        throw new Error('API not available');
                    }
                } catch {
                    // Use mock data for development
                    data = getMockLLMDebugData();
                }

                // Calculate total tokens - handle both summary format and full format
                const totalTokens = data.records.reduce((sum, r) => {
                    // Summary format has total_tokens directly
                    if (r.total_tokens !== undefined) return sum + r.total_tokens;
                    // Full format needs to sum from interactions
                    if (r.interactions) return sum + r.interactions.reduce((s, i) => s + (i.total_tokens || 0), 0);
                    return sum;
                }, 0);

                document.getElementById('recordCount').textContent = data.records.length;
                document.getElementById('tokenCount').textContent = formatTokens(totalTokens);

                allLLMRecords = data.records.sort((a, b) =>
                    new Date(b.created_at) - new Date(a.created_at)
                );

                filterLLMRecords();

                // If we have a selected record, refresh its data
                if (selectedLLMRecord && isFromAPI) {
                    // Re-fetch full record to get latest data
                    await selectLLMRecord(selectedLLMRecord.request_id);
                } else if (selectedLLMRecord) {
                    const updated = allLLMRecords.find(r => r.request_id === selectedLLMRecord.request_id);
                    if (updated) { selectedLLMRecord = updated; renderLLMDetail(); }
                }

                document.getElementById('llmLastUpdated').textContent = `Last updated: ${formatDateTime(new Date())}`;
                errorBanner.classList.remove('visible');
            } catch (error) {
                console.error('Failed to fetch LLM records:', error);
                document.getElementById('llmErrorMessage').textContent = error.message;
                errorBanner.classList.add('visible');
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // ==================== Mock Data ====================
        function getMockLLMDebugData() {
            const now = new Date();
            return {
                records: [
                    {
                        request_id: "debug-1736621234567-1",
                        original_request_id: "debug-1736621234567-1", // Same as request_id for initial request
                        trace_id: "369fecb4e3156c34e0950c61f1f99d62",
                        created_at: new Date(now - 60000).toISOString(),
                        updated_at: new Date(now - 58000).toISOString(),
                        interactions: [
                            {
                                type: "plan_generation",
                                timestamp: new Date(now - 60000).toISOString(),
                                duration_ms: 1523,
                                prompt: `You are an intelligent orchestrator for the GoMind framework.

Given the user request and available capabilities, generate an execution plan.

USER REQUEST: "What's the weather like in Tokyo and what are some good restaurants there?"

AVAILABLE CAPABILITIES:
1. weather-service.get_weather - Get current weather for a location
   Parameters: location (string, required)

2. restaurant-finder.search_restaurants - Find restaurants in a city
   Parameters: city (string, required), cuisine (string, optional)

Generate a JSON execution plan with steps to fulfill this request.`,
                                response: `{
  "routing_plan": {
    "steps": [
      {
        "step_id": "step-1",
        "capability": "weather-service.get_weather",
        "parameters": {"location": "Tokyo, Japan"},
        "depends_on": []
      },
      {
        "step_id": "step-2",
        "capability": "restaurant-finder.search_restaurants",
        "parameters": {"city": "Tokyo"},
        "depends_on": []
      }
    ],
    "synthesis_strategy": "llm"
  }
}`,
                                temperature: 0.3,
                                max_tokens: 2000,
                                model: "gpt-4o-mini",
                                provider: "openai",
                                prompt_tokens: 247,
                                completion_tokens: 156,
                                total_tokens: 403,
                                success: true,
                                attempt: 1
                            },
                            {
                                type: "synthesis",
                                timestamp: new Date(now - 58000).toISOString(),
                                duration_ms: 892,
                                prompt: `Synthesize the following tool results into a coherent, user-friendly response.

USER QUERY: "What's the weather like in Tokyo and what are some good restaurants there?"

TOOL RESULTS:
1. weather-service.get_weather:
   {"temperature": 22, "condition": "Partly Cloudy", "humidity": 65}

2. restaurant-finder.search_restaurants:
   {"restaurants": [{"name": "Sukiyabashi Jiro", "cuisine": "Sushi", "rating": 4.9}, {"name": "Narisawa", "cuisine": "French-Japanese", "rating": 4.8}]}

Create a natural, helpful response that combines this information.`,
                                response: `Based on the current conditions in Tokyo:

**Weather in Tokyo:**
The weather is pleasant at 22°C (72°F) with partly cloudy skies and 65% humidity - perfect weather for exploring the city!

**Top Restaurant Recommendations:**
Here are some excellent dining options:

1. **Sukiyabashi Jiro** ⭐ 4.9
   - Cuisine: Sushi
   - World-renowned sushi restaurant featured in "Jiro Dreams of Sushi"

2. **Narisawa** ⭐ 4.8
   - Cuisine: French-Japanese Fusion
   - Innovative dining experience blending French techniques with Japanese ingredients

Both restaurants are highly acclaimed and would make for a memorable dining experience during your visit!`,
                                temperature: 0.5,
                                max_tokens: 1500,
                                model: "gpt-4o-mini",
                                provider: "openai",
                                prompt_tokens: 312,
                                completion_tokens: 198,
                                total_tokens: 510,
                                success: true,
                                attempt: 1
                            }
                        ]
                    },
                    {
                        request_id: "debug-1736621200000-2",
                        original_request_id: "debug-1736621234567-1", // Part of same HITL conversation (resume)
                        trace_id: "abc123def456789012345678901234ab",
                        created_at: new Date(now - 300000).toISOString(),
                        updated_at: new Date(now - 298000).toISOString(),
                        interactions: [
                            {
                                type: "plan_generation",
                                timestamp: new Date(now - 300000).toISOString(),
                                duration_ms: 1234,
                                prompt: `You are an intelligent orchestrator for the GoMind framework.

USER REQUEST: "Convert 100 USD to EUR"

AVAILABLE CAPABILITIES:
1. currency-tool.convert - Convert between currencies
   Parameters: amount (number, required), from (string, required), to (string, required)

Generate a JSON execution plan.`,
                                response: `{
  "routing_plan": {
    "steps": [
      {
        "step_id": "step-1",
        "capability": "currency-tool.convert",
        "parameters": {"amount": 100, "from": "USD", "to": "EUR"},
        "depends_on": []
      }
    ],
    "synthesis_strategy": "simple"
  }
}`,
                                temperature: 0.3,
                                max_tokens: 2000,
                                model: "gpt-4o-mini",
                                provider: "openai",
                                prompt_tokens: 156,
                                completion_tokens: 89,
                                total_tokens: 245,
                                success: true,
                                attempt: 1
                            }
                        ]
                    },
                    {
                        request_id: "debug-1736620900000-3",
                        original_request_id: "debug-1736620900000-3", // Different conversation
                        trace_id: "error123trace456",
                        created_at: new Date(now - 600000).toISOString(),
                        updated_at: new Date(now - 598000).toISOString(),
                        interactions: [
                            {
                                type: "plan_generation",
                                timestamp: new Date(now - 600000).toISOString(),
                                duration_ms: 2100,
                                prompt: `You are an intelligent orchestrator...

USER REQUEST: "Book a flight to Mars"

AVAILABLE CAPABILITIES:
1. flight-search.search - Search for flights
   Parameters: from (string), to (string), date (string)`,
                                success: false,
                                error: "LLM rate limit exceeded. Please retry after 60 seconds.",
                                attempt: 1
                            },
                            {
                                type: "plan_generation",
                                timestamp: new Date(now - 598000).toISOString(),
                                duration_ms: 1456,
                                prompt: `You are an intelligent orchestrator...

USER REQUEST: "Book a flight to Mars"

AVAILABLE CAPABILITIES:
1. flight-search.search - Search for flights
   Parameters: from (string), to (string), date (string)`,
                                response: `{
  "routing_plan": {
    "steps": [],
    "error": "No capability available for interplanetary travel"
  }
}`,
                                temperature: 0.3,
                                max_tokens: 2000,
                                model: "gpt-4o",
                                provider: "openai",
                                prompt_tokens: 134,
                                completion_tokens: 45,
                                total_tokens: 179,
                                success: true,
                                attempt: 2
                            }
                        ]
                    },
                    {
                        request_id: "micro-1736620500000-4",
                        original_request_id: "debug-1736620900000-3", // Part of same conversation as record 3
                        created_at: new Date(now - 900000).toISOString(),
                        updated_at: new Date(now - 898000).toISOString(),
                        interactions: [
                            {
                                type: "micro_resolution",
                                timestamp: new Date(now - 900000).toISOString(),
                                duration_ms: 456,
                                prompt: `Extract the "city" parameter for the restaurant-finder.search_restaurants capability.

SOURCE DATA:
{
  "weather_result": {"location": "Paris, France", "temp": 18}
}

USER QUERY: "Find restaurants near where I checked the weather"

The city parameter should be extracted from the context. Return JSON with the resolved value.`,
                                response: `{"city": "Paris"}`,
                                temperature: 0.0,
                                max_tokens: 500,
                                model: "gpt-4o-mini",
                                provider: "openai",
                                prompt_tokens: 89,
                                completion_tokens: 12,
                                total_tokens: 101,
                                success: true,
                                attempt: 1,
                                step_id: "step-2"
                            }
                        ]
                    },
                    {
                        request_id: "reresolver-1736620000000-5",
                        original_request_id: "reresolver-1736620000000-5", // Different conversation
                        created_at: new Date(now - 1200000).toISOString(),
                        updated_at: new Date(now - 1198000).toISOString(),
                        interactions: [
                            {
                                type: "semantic_retry",
                                timestamp: new Date(now - 1200000).toISOString(),
                                duration_ms: 789,
                                prompt: `TASK: Re-resolve parameters after execution failure

USER REQUEST: "Get stock price for Apple"

SOURCE DATA FROM PREVIOUS STEPS:
{}

FAILED ATTEMPT:
- Capability: stock-market-tool.get_price
- Parameters sent: {"symbol": "Apple"}
- Error received: "Invalid symbol format. Expected ticker symbol like 'AAPL'"
- HTTP Status: 400

TARGET CAPABILITY SCHEMA:
- symbol (string, required): Stock ticker symbol (e.g., AAPL, GOOGL)

INSTRUCTIONS:
Analyze the error and provide corrected parameters.`,
                                response: `{
  "should_retry": true,
  "analysis": "The user said 'Apple' but the API requires the ticker symbol. Apple Inc's ticker is 'AAPL'.",
  "corrected_parameters": {
    "symbol": "AAPL"
  }
}`,
                                temperature: 0.0,
                                max_tokens: 1000,
                                model: "gpt-4o-mini",
                                provider: "openai",
                                prompt_tokens: 178,
                                completion_tokens: 67,
                                total_tokens: 245,
                                success: true,
                                attempt: 1,
                                step_id: "step-1"
                            }
                        ]
                    }
                ],
                timestamp: new Date().toISOString()
            };
        }

        // ==================== HITL Functions ====================
        function setHITLTypeFilter(filter) {
            currentHITLTypeFilter = filter;
            document.querySelectorAll('#hitlListPanel .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterHITLCheckpoints();
        }

        function sortHITLTable(column) {
            // Toggle direction if same column, else reset to ascending
            if (hitlSortColumn === column) {
                hitlSortDirection = hitlSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                hitlSortColumn = column;
                hitlSortDirection = 'asc';
            }

            // Update header classes
            document.querySelectorAll('#hitlTableBody').closest('table').querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === column) {
                    th.classList.add(hitlSortDirection);
                }
            });

            filterHITLCheckpoints();
        }

        function filterHITLCheckpoints() {
            const searchTerm = document.getElementById('hitlSearchInput').value.toLowerCase();
            const filtered = allHITLCheckpoints.filter(checkpoint => {
                const interruptType = checkpoint.interrupt_point || '';
                const isPlan = interruptType === 'plan_generated';
                const isStep = interruptType === 'before_step' || interruptType === 'after_step';
                const isError = interruptType === 'on_error';

                const matchesFilter = currentHITLTypeFilter === 'all' ||
                    (currentHITLTypeFilter === 'plan' && isPlan) ||
                    (currentHITLTypeFilter === 'step' && isStep) ||
                    (currentHITLTypeFilter === 'error' && isError);

                const matchesSearch = !searchTerm ||
                    checkpoint.checkpoint_id.toLowerCase().includes(searchTerm) ||
                    (checkpoint.original_request && checkpoint.original_request.toLowerCase().includes(searchTerm)) ||
                    (checkpoint.message && checkpoint.message.toLowerCase().includes(searchTerm)) ||
                    (checkpoint.reason && checkpoint.reason.toLowerCase().includes(searchTerm));

                return matchesFilter && matchesSearch;
            });

            // Apply column sorting
            filtered.sort((a, b) => {
                let aVal, bVal;

                if (hitlSortColumn === 'agent_name') {
                    aVal = (a.agent_name || '').toLowerCase();
                    bVal = (b.agent_name || '').toLowerCase();
                    const cmp = aVal.localeCompare(bVal);
                    return hitlSortDirection === 'asc' ? cmp : -cmp;
                } else if (hitlSortColumn === 'created_at') {
                    aVal = new Date(a.created_at || 0);
                    bVal = new Date(b.created_at || 0);
                } else if (hitlSortColumn === 'expires_at') {
                    aVal = new Date(a.expires_at || 0);
                    bVal = new Date(b.expires_at || 0);
                } else {
                    return 0;
                }

                const diff = aVal - bVal;
                return hitlSortDirection === 'asc' ? diff : -diff;
            });

            renderHITLTable(filtered);
        }

        function renderHITLTable(checkpoints) {
            const tbody = document.getElementById('hitlTableBody');
            if (checkpoints.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 48px;">
                    <div style="font-size: 32px; margin-bottom: 12px;">✓</div>
                    No pending checkpoints awaiting approval
                </td></tr>`;
                return;
            }

            tbody.innerHTML = checkpoints.map(cp => {
                const stepCount = cp.step_count || 0;
                const completedCount = cp.completed_count || 0;
                const progressPercent = stepCount > 0 ? Math.round((completedCount / stepCount) * 100) : 0;

                // Format interrupt point for display
                const interruptLabels = {
                    'plan_generated': '📋 Plan',
                    'before_step': '⏸️ Before Step',
                    'after_step': '✓ After Step',
                    'on_error': '⚠️ Error'
                };
                const interruptLabel = interruptLabels[cp.interrupt_point] || cp.interrupt_point;

                // Agent name display
                const agentName = cp.agent_name || '(default)';

                return `
                <tr onclick="selectHITLCheckpoint('${cp.checkpoint_id}')" class="${selectedHITLCheckpoint?.checkpoint_id === cp.checkpoint_id ? 'selected' : ''}">
                    <td><span class="priority-badge ${cp.priority || 'normal'}">${(cp.priority || 'normal').toUpperCase()}</span></td>
                    <td><span class="mono" style="font-size: 12px; color: var(--accent-blue);" title="${escapeHtml(agentName)}">${escapeHtml(truncateText(agentName, 20))}</span></td>
                    <td><span class="interrupt-badge ${cp.interrupt_point}">${interruptLabel}</span></td>
                    <td>
                        <div style="max-width: 250px;">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(cp.original_request || '')}">${escapeHtml(truncateText(cp.original_request || 'N/A', 40))}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(truncateText(cp.message || '', 50))}</div>
                        </div>
                    </td>
                    <td>
                        <div class="step-progress">
                            <div class="step-progress-bar">
                                <div class="step-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <span>${completedCount}/${stepCount}</span>
                        </div>
                    </td>
                    <td><span class="time-ago">${formatTimeAgo(cp.created_at)}</span></td>
                    <td><span class="time-ago" style="color: ${isExpiringSoon(cp.expires_at) ? 'var(--accent-orange)' : 'inherit'}">${formatTimeAgo(cp.expires_at)}</span></td>
                </tr>
            `}).join('');
        }

        function isExpiringSoon(expiresAt) {
            if (!expiresAt) return false;
            const expiresTime = new Date(expiresAt).getTime();
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            return expiresTime - now < fiveMinutes && expiresTime > now;
        }

        async function selectHITLCheckpoint(checkpointId) {
            // Check if we already have the full checkpoint
            const summaryCheckpoint = allHITLCheckpoints.find(c => c.checkpoint_id === checkpointId);

            // Fetch full checkpoint details from API
            try {
                const response = await fetch(`/api/hitl/checkpoints/${encodeURIComponent(checkpointId)}`);
                if (response.ok) {
                    selectedHITLCheckpoint = await response.json();
                } else if (summaryCheckpoint) {
                    // API failed but we have summary - use what we can
                    selectedHITLCheckpoint = summaryCheckpoint;
                } else {
                    selectedHITLCheckpoint = null;
                }
            } catch (error) {
                console.error('Failed to fetch HITL checkpoint:', error);
                // Fallback to mock if available
                const mockCheckpoint = getMockHITLCheckpoint(checkpointId);
                selectedHITLCheckpoint = mockCheckpoint || summaryCheckpoint || null;
            }

            filterHITLCheckpoints();
            renderHITLDetail();
        }

        function setHITLDetailTab(tab) {
            currentHITLTab = tab;
            document.querySelectorAll('#hitlDetailPanel .detail-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            renderHITLDetail();
        }

        function renderHITLDetail() {
            const content = document.getElementById('hitlDetailContent');
            const title = document.getElementById('hitlDetailTitle');

            if (!selectedHITLCheckpoint) {
                title.textContent = 'Select a checkpoint';
                content.innerHTML = `<div class="empty-detail"><div class="empty-detail-icon">✋</div><div>Select a checkpoint to view details</div></div>`;
                return;
            }

            title.textContent = `Checkpoint: ${truncateText(selectedHITLCheckpoint.checkpoint_id, 20)}`;

            if (currentHITLTab === 'json') {
                content.innerHTML = `<div class="json-container"><button class="copy-btn" onclick="copyHITLJson(event)">Copy</button><pre class="json-view">${syntaxHighlightJson(selectedHITLCheckpoint)}</pre></div>`;
            } else if (currentHITLTab === 'plan') {
                content.innerHTML = renderHITLPlanView(selectedHITLCheckpoint);
            } else {
                content.innerHTML = renderHITLOverviewView(selectedHITLCheckpoint);
            }
        }

        function renderHITLOverviewView(checkpoint) {
            let html = `<div class="formatted-view">`;

            // Decision Info (the reason for interruption)
            if (checkpoint.decision) {
                const decision = checkpoint.decision;
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">⚠️</span> Interrupt Decision</div><div class="info-grid">
                    <div class="info-label">Reason</div><div class="info-value"><span class="priority-badge ${decision.priority || 'normal'}">${decision.reason || 'N/A'}</span></div>
                    <div class="info-label">Priority</div><div class="info-value"><span class="priority-badge ${decision.priority || 'normal'}">${(decision.priority || 'normal').toUpperCase()}</span></div>
                    <div class="info-label">Message</div><div class="info-value">${escapeHtml(decision.message || 'N/A')}</div>
                    ${decision.default_action ? `<div class="info-label">Default Action</div><div class="info-value"><span class="action-badge ${decision.default_action}">${decision.default_action.toUpperCase()}</span></div>` : ''}
                </div></div>`;
            }

            // Checkpoint Info
            const agentName = checkpoint.agent_name || '(default)';
            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">📊</span> Checkpoint Info</div><div class="info-grid">
                <div class="info-label">Checkpoint ID</div><div class="info-value mono">${checkpoint.checkpoint_id}</div>
                <div class="info-label">Request ID</div><div class="info-value mono">${checkpoint.request_id}</div>
                <div class="info-label">Agent</div><div class="info-value"><span style="color: var(--accent-blue); font-weight: 500;">${escapeHtml(agentName)}</span></div>
                <div class="info-label">Interrupt Point</div><div class="info-value"><span class="interrupt-badge ${checkpoint.interrupt_point}">${checkpoint.interrupt_point}</span></div>
                <div class="info-label">Status</div><div class="info-value"><span class="status-badge ${checkpoint.status === 'pending' ? 'error' : 'success'}">${checkpoint.status}</span></div>
                <div class="info-label">Created</div><div class="info-value">${formatDateTime(checkpoint.created_at)}</div>
                <div class="info-label">Expires</div><div class="info-value" style="color: ${isExpiringSoon(checkpoint.expires_at) ? 'var(--accent-orange)' : 'inherit'}">${formatDateTime(checkpoint.expires_at)}</div>
            </div></div>`;

            // Original Request
            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">💬</span> Original Request</div>
                <div style="padding: 16px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 14px; line-height: 1.6;">
                    ${escapeHtml(checkpoint.original_request || 'N/A')}
                </div>
            </div>`;

            // Current Step (if applicable) - the step awaiting approval
            if (checkpoint.current_step) {
                const step = checkpoint.current_step;
                // Handle capability from metadata fallback (orchestrator stores capability in metadata.capability)
                const capability = step.capability || step.metadata?.capability || '';
                const params = (step.parameters && Object.keys(step.parameters).length > 0) ? step.parameters : step.metadata?.parameters;
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">⏸️</span> Blocked Step (Awaiting Approval)</div>
                    <div class="plan-step-card current">
                        <div class="plan-step-header">
                            <span class="plan-step-id">${step.step_id}</span>
                            <span class="plan-step-status current">⏳ AWAITING APPROVAL</span>
                        </div>
                        ${capability ? `<div class="plan-step-capability">${escapeHtml(capability)}</div>` : ''}
                        ${step.service_name ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Service: <span style="color: var(--accent-blue);">${escapeHtml(step.service_name)}</span>${step.capability_name ? ` • Capability: <span style="color: var(--accent-green);">${escapeHtml(step.capability_name)}</span>` : ''}</div>` : ''}
                        ${step.instruction ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-style: italic;">📝 ${escapeHtml(step.instruction)}</div>` : ''}
                        ${step.description ? `<div class="plan-step-description">${escapeHtml(step.description)}</div>` : ''}
                        ${params && Object.keys(params).length > 0 ? `<div class="plan-step-params">${JSON.stringify(params, null, 2)}</div>` : ''}
                        ${step.depends_on && step.depends_on.length > 0 ? `<div class="plan-step-depends">Depends on: ${step.depends_on.join(', ')}</div>` : ''}
                    </div>
                </div>`;
            }

            // Resolved Parameters (for step-level HITL)
            if (checkpoint.resolved_parameters && Object.keys(checkpoint.resolved_parameters).length > 0) {
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">🔧</span> Resolved Parameters</div>
                    <div class="plan-step-params">${JSON.stringify(checkpoint.resolved_parameters, null, 2)}</div>
                </div>`;
            }

            // Completed Steps (show what has already executed)
            if (checkpoint.completed_steps && checkpoint.completed_steps.length > 0) {
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">✅</span> Completed Steps (${checkpoint.completed_steps.length})</div>`;
                checkpoint.completed_steps.forEach((result, index) => {
                    const statusClass = result.success ? 'completed' : 'error';
                    const statusIcon = result.success ? '✓' : '✗';
                    const statusLabel = result.success ? 'SUCCESS' : 'FAILED';
                    const serviceName = result.agent_name || result.service_name || result.capability?.split('.')[0] || 'unknown';
                    const durationMs = result.duration_ms || (result.duration ? Math.round(result.duration / 1000000) : null);
                    html += `<div class="plan-step-card ${statusClass}" style="margin-bottom: 8px;">
                        <div class="plan-step-header">
                            <span class="plan-step-id">${result.step_id}</span>
                            <span class="plan-step-status ${statusClass}">${statusIcon} ${statusLabel}</span>
                        </div>
                        <div class="plan-step-capability">${escapeHtml(serviceName)}</div>
                        ${result.instruction ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-style: italic;">📝 ${escapeHtml(result.instruction)}</div>` : ''}
                        ${durationMs ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Duration: ${formatDuration(durationMs)}${result.attempts > 1 ? ` (${result.attempts} attempts)` : ''}</div>` : ''}
                        ${result.error ? `<div style="font-size: 12px; color: var(--accent-red); margin-top: 8px; padding: 8px; background: rgba(255,59,48,0.1); border-radius: 6px;">Error: ${escapeHtml(result.error)}</div>` : ''}
                        ${result.response_text ? `<div class="plan-step-params" style="margin-top: 8px;"><div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Response:</div><div style="white-space: pre-wrap;">${escapeHtml(result.response_text)}</div></div>` :
                          (result.response ? `<div class="plan-step-params" style="margin-top: 8px;"><div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Response:</div>${formatJsonResponse(result.response)}</div>` : '')}
                    </div>`;
                });
                html += `</div>`;
            }

            // Current Step Result (for error escalation)
            if (checkpoint.current_step_result) {
                const result = checkpoint.current_step_result;
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">❌</span> Error Details</div>
                    <div class="info-grid">
                        <div class="info-label">Step</div><div class="info-value mono">${result.capability}</div>
                        ${result.service_name ? `<div class="info-label">Service</div><div class="info-value">${escapeHtml(result.service_name)}</div>` : ''}
                        ${result.instruction ? `<div class="info-label">Instruction</div><div class="info-value" style="font-style: italic;">${escapeHtml(result.instruction)}</div>` : ''}
                        <div class="info-label">Duration</div><div class="info-value">${formatDuration(result.duration_ms || 0)}${result.attempts > 1 ? ` (${result.attempts} attempts)` : ''}</div>
                        <div class="info-label">Error</div><div class="info-value" style="color: var(--accent-red);">${escapeHtml(result.error || 'Unknown error')}</div>
                    </div>
                </div>`;
            }

            // User Context
            if (checkpoint.user_context && Object.keys(checkpoint.user_context).length > 0) {
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">👤</span> User Context</div><div class="info-grid">
                    ${Object.entries(checkpoint.user_context).map(([key, value]) => `<div class="info-label">${key}</div><div class="info-value mono">${value}</div>`).join('')}
                </div></div>`;
            }

            html += `</div>`;
            return html;
        }

        function renderHITLPlanView(checkpoint) {
            if (!checkpoint.plan || !checkpoint.plan.steps) {
                return `<div class="empty-detail"><div class="empty-detail-icon">📋</div><div>No execution plan available</div></div>`;
            }

            const plan = checkpoint.plan;
            // Create a map of completed step results for quick lookup
            const completedStepsMap = new Map((checkpoint.completed_steps || []).map(s => [s.step_id, s]));
            const currentStepId = checkpoint.current_step?.step_id;

            let html = `<div class="formatted-view">`;

            // Plan summary with agent name and checkpoint status
            const agentName = checkpoint.agent_name || '(default)';
            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">📋</span> Execution Plan</div><div class="info-grid">
                ${plan.request_id ? `<div class="info-label">Request ID</div><div class="info-value mono">${plan.request_id}</div>` : ''}
                <div class="info-label">Agent</div><div class="info-value"><span style="color: var(--accent-blue); font-weight: 500;">${escapeHtml(agentName)}</span></div>
                <div class="info-label">Status</div><div class="info-value"><span class="status-badge ${checkpoint.status === 'pending' ? 'error' : 'success'}">${checkpoint.status || 'unknown'}</span></div>
                <div class="info-label">Total Steps</div><div class="info-value">${plan.steps.length}</div>
                <div class="info-label">Completed</div><div class="info-value">${completedStepsMap.size}</div>
                ${plan.synthesis_strategy ? `<div class="info-label">Synthesis</div><div class="info-value">${plan.synthesis_strategy}</div>` : ''}
            </div></div>`;

            // Rationale
            if (plan.rationale) {
                html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">💭</span> Plan Rationale</div>
                    <div style="padding: 16px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                        ${escapeHtml(plan.rationale)}
                    </div>
                </div>`;
            }

            // Steps
            html += `<div class="info-section"><div class="info-section-title"><span class="section-icon">📝</span> Plan Steps (${plan.steps.length})</div>`;

            plan.steps.forEach((step, index) => {
                const completedResult = completedStepsMap.get(step.step_id);
                const isCompleted = !!completedResult;
                const isCurrent = step.step_id === currentStepId;
                const status = isCompleted ? (completedResult.success ? 'completed' : 'error') : (isCurrent ? 'current' : 'pending');
                const statusIcon = isCompleted ? (completedResult.success ? '✓' : '✗') : (isCurrent ? '⏸' : '○');
                const statusLabel = isCompleted ? (completedResult.success ? 'COMPLETED' : 'FAILED') : (isCurrent ? 'BLOCKED' : 'PENDING');

                // Handle capability from metadata fallback (orchestrator stores capability in metadata.capability)
                const capability = step.capability || step.metadata?.capability || '';
                const serviceName = step.service_name || '';
                const capabilityName = step.capability_name || '';
                // Parameters can be at top level or in metadata
                const params = (step.parameters && Object.keys(step.parameters).length > 0) ? step.parameters : step.metadata?.parameters;

                html += `<div class="plan-step-card ${status}">
                    <div class="plan-step-header">
                        <span class="plan-step-id">${step.step_id}</span>
                        <span class="plan-step-status ${status}">${statusIcon} ${statusLabel}</span>
                    </div>
                    ${capability ? `<div class="plan-step-capability">${escapeHtml(capability)}</div>` : ''}
                    ${serviceName ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Service: <span style="color: var(--accent-blue);">${escapeHtml(serviceName)}</span>${capabilityName ? ` • Capability: <span style="color: var(--accent-green);">${escapeHtml(capabilityName)}</span>` : ''}</div>` : ''}
                    ${step.instruction ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-style: italic;">📝 ${escapeHtml(step.instruction)}</div>` : ''}
                    ${step.description ? `<div class="plan-step-description">${escapeHtml(step.description)}</div>` : ''}
                    ${params && Object.keys(params).length > 0 ? `
                        <div class="plan-step-params"><div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Parameters:</div>${JSON.stringify(params, null, 2)}</div>
                    ` : ''}
                    ${step.depends_on && step.depends_on.length > 0 ? `
                        <div class="plan-step-depends">Depends on: ${step.depends_on.join(', ')}</div>
                    ` : ''}
                    ${completedResult ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Execution Result:</div>
                            ${completedResult.instruction ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-style: italic;">📝 ${escapeHtml(completedResult.instruction)}</div>` : ''}
                            ${(completedResult.duration_ms || completedResult.duration) ? `<div style="font-size: 11px; color: var(--text-muted);">Duration: ${formatDuration(completedResult.duration_ms || Math.round(completedResult.duration / 1000000))}${completedResult.attempts > 1 ? ` (${completedResult.attempts} attempts)` : ''}</div>` : ''}
                            ${completedResult.error ? `<div style="font-size: 12px; color: var(--accent-red); margin-top: 8px; padding: 8px; background: rgba(255,59,48,0.1); border-radius: 6px;">Error: ${escapeHtml(completedResult.error)}</div>` : ''}
                            ${completedResult.response_text ? `<div class="plan-step-params" style="margin-top: 8px;"><div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Response:</div><div style="white-space: pre-wrap;">${escapeHtml(completedResult.response_text)}</div></div>` :
                              (completedResult.response ? `<div class="plan-step-params" style="margin-top: 8px;"><div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Response:</div>${formatJsonResponse(completedResult.response)}</div>` : '')}
                        </div>
                    ` : ''}
                </div>`;
            });

            html += `</div></div>`;
            return html;
        }

        function copyHITLJson(evt) {
            const text = JSON.stringify(selectedHITLCheckpoint, null, 2);
            copyToClipboard(text, evt);
        }

        async function fetchHITLCheckpoints() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const errorBanner = document.getElementById('hitlErrorBanner');
            refreshBtn.classList.add('loading');

            try {
                let data;
                try {
                    const response = await fetch('/api/hitl/checkpoints');
                    if (response.ok) {
                        data = await response.json();
                    } else {
                        throw new Error('API not available');
                    }
                } catch {
                    // Use mock data for development
                    data = getMockHITLData();
                }

                // Count critical checkpoints
                const criticalCount = data.checkpoints.filter(c => c.priority === 'critical').length;

                document.getElementById('pendingCount').textContent = data.checkpoints.length;
                document.getElementById('criticalCount').textContent = criticalCount;

                allHITLCheckpoints = data.checkpoints.sort((a, b) => {
                    // Sort by priority (critical first), then by created_at
                    const priorityOrder = { critical: 0, high: 1, normal: 2, low: 3 };
                    const aPriority = priorityOrder[a.priority] ?? 2;
                    const bPriority = priorityOrder[b.priority] ?? 2;
                    if (aPriority !== bPriority) return aPriority - bPriority;
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                filterHITLCheckpoints();

                // Refresh selected checkpoint if still exists
                if (selectedHITLCheckpoint) {
                    const updated = allHITLCheckpoints.find(c => c.checkpoint_id === selectedHITLCheckpoint.checkpoint_id);
                    if (updated) {
                        await selectHITLCheckpoint(selectedHITLCheckpoint.checkpoint_id);
                    } else {
                        // Checkpoint was resolved/expired
                        selectedHITLCheckpoint = null;
                        renderHITLDetail();
                    }
                }

                document.getElementById('hitlLastUpdated').textContent = `Last updated: ${formatDateTime(new Date())}`;
                errorBanner.classList.remove('visible');
            } catch (error) {
                console.error('Failed to fetch HITL checkpoints:', error);
                document.getElementById('hitlErrorMessage').textContent = error.message;
                errorBanner.classList.add('visible');
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // Mock data for HITL development
        function getMockHITLData() {
            const now = new Date();
            return {
                checkpoints: [
                    {
                        checkpoint_id: "cp-abc123-plan",
                        request_id: "req-travel-001",
                        interrupt_point: "plan_generated",
                        reason: "plan_approval",
                        priority: "normal",
                        message: "Execution plan requires approval before proceeding",
                        original_request: "What's the weather in Tokyo and book me a flight there?",
                        step_count: 3,
                        completed_count: 0,
                        current_step: "",
                        created_at: new Date(now - 2 * 60000).toISOString(),
                        expires_at: new Date(now.getTime() + 5 * 60000).toISOString(),
                        status: "pending",
                        agent_name: "travel-agent"
                    },
                    {
                        checkpoint_id: "cp-def456-step",
                        request_id: "req-stock-002",
                        interrupt_point: "before_step",
                        reason: "sensitive_operation",
                        priority: "high",
                        message: "About to execute sensitive operation: stock_trade.execute_trade",
                        original_request: "Buy 100 shares of AAPL",
                        step_count: 2,
                        completed_count: 1,
                        current_step: "stock_trade.execute_trade",
                        created_at: new Date(now - 5 * 60000).toISOString(),
                        expires_at: new Date(now.getTime() + 10 * 60000).toISOString(),
                        status: "pending",
                        agent_name: "trading-bot"
                    },
                    {
                        checkpoint_id: "cp-ghi789-error",
                        request_id: "req-payment-003",
                        interrupt_point: "on_error",
                        reason: "escalation",
                        priority: "critical",
                        message: "Payment processing failed after 3 retries - human intervention required",
                        original_request: "Process refund for order #12345",
                        step_count: 1,
                        completed_count: 0,
                        current_step: "payment.process_refund",
                        created_at: new Date(now - 10 * 60000).toISOString(),
                        expires_at: new Date(now.getTime() + 30 * 60000).toISOString(),
                        status: "pending",
                        agent_name: "payment-service"
                    }
                ],
                total: 3,
                timestamp: now.toISOString()
            };
        }

        function getMockHITLCheckpoint(checkpointId) {
            // For mock mode, return detailed checkpoint data
            const mockData = getMockHITLData();
            const summary = mockData.checkpoints.find(c => c.checkpoint_id === checkpointId);
            if (!summary) return null;

            // Expand to full checkpoint (simulating API response)
            const now = new Date();
            if (checkpointId === 'cp-abc123-plan') {
                return {
                    ...summary,
                    decision: {
                        should_interrupt: true,
                        reason: "plan_approval",
                        message: "Execution plan requires approval before proceeding",
                        priority: "normal",
                        default_action: "approve"
                    },
                    plan: {
                        request_id: "req-travel-001",
                        steps: [
                            { step_id: "step-1", capability: "weather-tool.get_weather", service_name: "weather-tool", capability_name: "get_weather", parameters: { location: "Tokyo, Japan" }, depends_on: [], description: "Get current weather for Tokyo" },
                            { step_id: "step-2", capability: "flight-search.search_flights", service_name: "flight-search", capability_name: "search_flights", parameters: { destination: "Tokyo", date: "2024-03-15" }, depends_on: [], description: "Search for available flights to Tokyo" },
                            { step_id: "step-3", capability: "flight-booking.book_flight", service_name: "flight-booking", capability_name: "book_flight", parameters: { flight_id: "{{step-2.flights[0].id}}" }, depends_on: ["step-2"], description: "Book the selected flight" }
                        ],
                        synthesis_strategy: "llm",
                        rationale: "User wants weather info and flight booking. Steps 1 and 2 can run in parallel, step 3 depends on step 2 results."
                    },
                    completed_steps: [],
                    user_context: { user_id: "user-123", session_id: "session-abc" }
                };
            } else if (checkpointId === 'cp-def456-step') {
                return {
                    ...summary,
                    decision: {
                        should_interrupt: true,
                        reason: "sensitive_operation",
                        message: "About to execute sensitive operation: stock_trade.execute_trade",
                        priority: "high"
                    },
                    plan: {
                        steps: [
                            { step_id: "step-1", capability: "stock-market.get_quote", service_name: "stock-market", capability_name: "get_quote", parameters: { symbol: "AAPL" }, depends_on: [], description: "Get current stock quote for AAPL" },
                            { step_id: "step-2", capability: "stock_trade.execute_trade", service_name: "stock-trade", capability_name: "execute_trade", parameters: { symbol: "AAPL", quantity: 100, action: "buy" }, depends_on: ["step-1"], description: "Execute buy order for 100 shares of AAPL" }
                        ]
                    },
                    completed_steps: [{
                        step_id: "step-1",
                        capability: "stock-market.get_quote",
                        service_name: "stock-market",
                        instruction: "Get the current stock price and trading information for AAPL",
                        success: true,
                        response: { symbol: "AAPL", price: 178.50, change: "+2.35", volume: "45.2M" },
                        response_text: "AAPL is currently trading at $178.50, up $2.35 (+1.33%) today with volume of 45.2M shares.",
                        duration_ms: 234,
                        attempts: 1
                    }],
                    current_step: { step_id: "step-2", capability: "stock_trade.execute_trade", service_name: "stock-trade", capability_name: "execute_trade", instruction: "Execute a market buy order for 100 shares of AAPL at current price", parameters: { symbol: "AAPL", quantity: 100, action: "buy" }, depends_on: ["step-1"], description: "Execute buy order for 100 shares of AAPL" },
                    resolved_parameters: { symbol: "AAPL", quantity: 100, action: "buy", price: 178.50, total: 17850.00 },
                    user_context: { user_id: "user-456", account_type: "premium" }
                };
            } else if (checkpointId === 'cp-ghi789-error') {
                return {
                    ...summary,
                    decision: {
                        should_interrupt: true,
                        reason: "escalation",
                        message: "Payment processing failed after 3 retries - human intervention required",
                        priority: "critical"
                    },
                    plan: {
                        steps: [{ step_id: "step-1", capability: "payment.process_refund", service_name: "payment-gateway", capability_name: "process_refund", parameters: { order_id: "#12345", amount: 99.99 }, depends_on: [], description: "Process refund for the order" }]
                    },
                    completed_steps: [],
                    current_step: { step_id: "step-1", capability: "payment.process_refund", service_name: "payment-gateway", capability_name: "process_refund", parameters: { order_id: "#12345", amount: 99.99 }, description: "Process refund for the order" },
                    current_step_result: { step_id: "step-1", capability: "payment.process_refund", service_name: "payment-gateway", instruction: "Process a refund of $99.99 for order #12345", success: false, error: "Payment gateway timeout after 30s - gateway returned 504", duration_ms: 30234, attempts: 3 },
                    user_context: { user_id: "user-789", order_id: "#12345", customer: "John Doe", email: "john@example.com" }
                };
            }
            return summary;
        }

        // ==================== Auto Refresh ====================
        function updateAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(() => {
                    if (currentView === 'registry') {
                        fetchServices();
                    } else if (currentView === 'llm-debug') {
                        fetchLLMRecords();
                    } else if (currentView === 'hitl') {
                        fetchHITLCheckpoints();
                    }
                }, 5000);
            }
        }

        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            checkbox.addEventListener('change', updateAutoRefresh);
            updateAutoRefresh();
        }

        // ==================== Resizable Panels ====================
        function setupResizablePanels() {
            setupResizeHandle('registryResizeHandle', 'registryListPanel', '35%');
            setupResizeHandle('llmResizeHandle', 'llmDebugListPanel', '35%');
            setupResizeHandle('hitlResizeHandle', 'hitlListPanel', '40%');
            setupResizeHandle('dagResizeHandle', 'dagListPanel', '35%');
        }

        function setupResizeHandle(handleId, panelId, defaultWidth) {
            const resizeHandle = document.getElementById(handleId);
            const listPanel = document.getElementById(panelId);
            const mainContainer = document.getElementById('mainContainer');

            if (!resizeHandle || !listPanel) return;

            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = listPanel.offsetWidth;

                resizeHandle.classList.add('active');
                document.body.classList.add('resizing');

                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerWidth = mainContainer.offsetWidth;
                const deltaX = e.clientX - startX;
                let newWidth = startWidth + deltaX;

                // Enforce min/max constraints
                const minWidth = 280;
                const maxWidth = containerWidth * 0.7;
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));

                // Calculate percentage
                const widthPercent = (newWidth / containerWidth) * 100;
                listPanel.style.width = `${widthPercent}%`;
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('active');
                    document.body.classList.remove('resizing');
                }
            });

            // Double-click to reset to default width
            resizeHandle.addEventListener('dblclick', () => {
                listPanel.style.width = defaultWidth;
            });
        }

        // ==================== Execution DAG Functions ====================
        async function fetchExecutions() {
            try {
                const response = await fetch('/api/executions?limit=50');
                const data = await response.json();
                allExecutions = data.executions || [];
                renderExecutionList();
                updateDagStats();
            } catch (error) {
                console.error('Failed to fetch executions:', error);
                document.getElementById('dagList').innerHTML =
                    '<div class="error-state">Failed to load executions</div>';
            }
        }

        function updateDagStats() {
            const total = allExecutions.length;
            const successful = allExecutions.filter(e => e.success).length;
            const rate = total > 0 ? Math.round((successful / total) * 100) : 0;

            document.getElementById('executionCount').textContent = total;
            document.getElementById('successRate').textContent = `${rate}%`;
        }

        function filterExecutions() {
            renderExecutionList();
        }

        function setDagFilter(filter) {
            currentDagFilter = filter;
            document.querySelectorAll('#dagListPanel .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderExecutionList();
        }

        function sortDagTable(column) {
            // Update sort indicators in the header
            document.querySelectorAll('#dagListPanel th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });

            if (dagSortColumn === column) {
                dagSortDirection = dagSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                dagSortColumn = column;
                dagSortDirection = column === 'created_at' ? 'desc' : 'asc';
            }

            const th = document.querySelector(`#dagListPanel th[data-sort="${column}"]`);
            if (th) th.classList.add(dagSortDirection);

            renderExecutionList();
        }

        function renderExecutionList() {
            const container = document.getElementById('dagTableBody');
            const searchTerm = document.getElementById('dagSearchInput').value.toLowerCase();

            let filtered = allExecutions.filter(exec => {
                if (currentDagFilter === 'success' && (!exec.success || exec.interrupted)) return false;
                if (currentDagFilter === 'failed' && (exec.success || exec.interrupted)) return false;
                if (currentDagFilter === 'interrupted' && !exec.interrupted) return false;
                if (searchTerm && !exec.original_request.toLowerCase().includes(searchTerm) &&
                    !exec.request_id.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            // Sort the filtered list
            filtered.sort((a, b) => {
                let valA, valB;
                switch (dagSortColumn) {
                    case 'original_request':
                        valA = (a.original_request || '').toLowerCase();
                        valB = (b.original_request || '').toLowerCase();
                        break;
                    case 'total_duration_ms':
                        valA = a.total_duration_ms || 0;
                        valB = b.total_duration_ms || 0;
                        break;
                    case 'created_at':
                    default:
                        valA = new Date(a.created_at).getTime();
                        valB = new Date(b.created_at).getTime();
                        break;
                }
                if (valA < valB) return dagSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return dagSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div class="empty-state-icon" style="font-size: 40px; margin-bottom: 12px;">🔀</div>
                            <div style="color: var(--text-muted);">No executions found</div>
                        </td>
                    </tr>`;
                return;
            }

            // Group executions by original_request_id for HITL parent-child display
            // Parent: where request_id === original_request_id or no original_request_id
            // Child: where original_request_id exists and differs from request_id
            const groups = new Map(); // key: original_request_id, value: { parent: exec, children: [exec...] }

            filtered.forEach(exec => {
                const groupKey = exec.original_request_id || exec.request_id;
                const isParent = !exec.original_request_id || exec.request_id === exec.original_request_id;

                if (!groups.has(groupKey)) {
                    groups.set(groupKey, { parent: null, children: [] });
                }

                const group = groups.get(groupKey);
                if (isParent) {
                    group.parent = exec;
                } else {
                    group.children.push(exec);
                }
            });

            // Sort children within each group by created_at (oldest first, so conversation flows naturally)
            groups.forEach(group => {
                group.children.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            });

            // Convert groups to ordered array (sorted by current sort column/direction)
            const orderedGroups = Array.from(groups.values())
                .filter(g => g.parent) // Only groups with a parent
                .sort((a, b) => {
                    let valA, valB;
                    switch (dagSortColumn) {
                        case 'original_request':
                            valA = (a.parent.original_request || '').toLowerCase();
                            valB = (b.parent.original_request || '').toLowerCase();
                            break;
                        case 'total_duration_ms':
                            valA = a.parent.total_duration_ms || 0;
                            valB = b.parent.total_duration_ms || 0;
                            break;
                        case 'created_at':
                        default:
                            valA = new Date(a.parent.created_at).getTime();
                            valB = new Date(b.parent.created_at).getTime();
                            break;
                    }
                    if (valA < valB) return dagSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return dagSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

            // Handle orphan children (where parent wasn't in filtered results)
            groups.forEach((group, groupKey) => {
                if (!group.parent && group.children.length > 0) {
                    // Promote first child as pseudo-parent for display
                    group.parent = group.children.shift();
                    orderedGroups.push(group);
                }
            });

            // Re-sort after adding orphans to maintain correct order
            orderedGroups.sort((a, b) => {
                let valA, valB;
                switch (dagSortColumn) {
                    case 'original_request':
                        valA = (a.parent.original_request || '').toLowerCase();
                        valB = (b.parent.original_request || '').toLowerCase();
                        break;
                    case 'total_duration_ms':
                        valA = a.parent.total_duration_ms || 0;
                        valB = b.parent.total_duration_ms || 0;
                        break;
                    case 'created_at':
                    default:
                        valA = new Date(a.parent.created_at).getTime();
                        valB = new Date(b.parent.created_at).getTime();
                        break;
                }
                if (valA < valB) return dagSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return dagSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Helper to render a single execution row
            const renderRow = (exec, isChild = false, hasChildren = false) => {
                const isSelected = selectedExecution?.request_id === exec.request_id;
                const childClass = isChild ? 'child-row' : '';
                const expandableClass = hasChildren ? 'expandable' : '';

                return `
                <tr class="${isSelected ? 'selected' : ''} ${childClass} ${expandableClass}"
                    onclick="selectExecution('${exec.request_id}')"
                    data-request-id="${exec.request_id}"
                    data-original-request-id="${exec.original_request_id || exec.request_id}">
                    <td>
                        <span class="status-badge ${exec.interrupted ? 'interrupted' : (exec.success ? 'success' : 'error')}">
                            ${exec.interrupted ? '⏸ Interrupted' : (exec.success ? '✓ Success' : '✗ Failed')}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: flex-start;">
                            ${isChild ? '<span class="child-indicator">↳</span>' : ''}
                            <div style="flex: 1;">
                                <div class="service-name" style="margin-bottom: 4px;">
                                    ${truncateText(exec.original_request, isChild ? 50 : 60)}
                                </div>
                                <span class="request-id">${exec.request_id}</span>
                                ${isChild ? '<span class="hitl-resume-badge">HITL Resume</span>' : ''}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="step-progress">
                            <span>${exec.step_count} steps</span>
                            ${exec.failed_steps > 0 ? `
                                <span style="color: var(--accent-red); font-size: 11px;">(${exec.failed_steps} failed)</span>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <span style="font-family: 'SF Mono', monospace; font-size: 12px;">
                            ${formatDuration(exec.total_duration_ms)}
                        </span>
                    </td>
                    <td>
                        <span class="time-ago">${formatTimeAgo(exec.created_at)}</span>
                    </td>
                </tr>`;
            };

            // Build HTML: parent followed by its children
            const rows = [];
            orderedGroups.forEach(group => {
                const hasChildren = group.children.length > 0;
                rows.push(renderRow(group.parent, false, hasChildren));
                group.children.forEach(child => {
                    rows.push(renderRow(child, true, false));
                });
            });

            container.innerHTML = rows.join('');

            // Update last updated timestamp
            document.getElementById('dagLastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        async function selectExecution(requestId) {
            try {
                // Use unified endpoint to get execution, LLM debug, and HITL data in one call
                const response = await fetch(`/api/executions/${requestId}/unified`);
                selectedExecution = await response.json();
                renderExecutionList();
                updateDetailTabs(); // Update tab visibility based on available data
                renderExecutionDetail();
            } catch (error) {
                console.error('Failed to fetch execution:', error);
            }
        }

        // Update tab visibility based on available data
        function updateDetailTabs() {
            const llmTab = document.querySelector('[data-tab="dag-llm"]');
            const hitlTab = document.querySelector('[data-tab="dag-hitl"]');

            if (llmTab) {
                llmTab.style.display = selectedExecution?.has_llm_data ? 'block' : 'none';
            }
            if (hitlTab) {
                hitlTab.style.display = selectedExecution?.has_hitl_data ? 'block' : 'none';
            }
        }

        function setDagDetailTab(tab) {
            currentDagTab = tab;
            document.querySelectorAll('#dagDetailPanel .detail-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            renderExecutionDetail();
        }

        function renderExecutionDetail() {
            if (!selectedExecution) return;

            const container = document.getElementById('dagDetailContent');

            // Update detail title
            document.getElementById('dagDetailTitle').textContent = truncateText(selectedExecution.original_request, 50);

            if (currentDagTab === 'dag-viz') {
                renderDAGVisualization(container);
            } else if (currentDagTab === 'dag-steps') {
                renderStepDetails(container);
            } else if (currentDagTab === 'dag-llm') {
                renderLLMCalls(container);
            } else if (currentDagTab === 'dag-hitl') {
                renderHITLCheckpoints(container);
            } else if (currentDagTab === 'dag-raw') {
                container.innerHTML = `
                    <div class="json-container">
                        <button class="copy-btn" onclick="copyToClipboard(JSON.stringify(selectedExecution, null, 2), event)">Copy</button>
                        <div class="json-view">${syntaxHighlightJson(selectedExecution)}</div>
                    </div>`;
            }
        }

        function renderDAGVisualization(container) {
            const stepCount = selectedExecution.plan?.steps?.length || 0;
            const hasLLM = selectedExecution.has_llm_data;
            const hasHITL = selectedExecution.has_hitl_data;
            const llmCallCount = selectedExecution.llm_interactions?.length || 0;

            // Compute total duration: executor time (tool calls) + LLM time (AI calls)
            // These are additive because executor handles tool invocations, LLM handles AI planning/synthesis
            const executorDurationMs = selectedExecution.total_duration_ms || 0;
            const llmDurationMs = selectedExecution.llm_debug_summary?.total_duration_ms || 0;
            const totalDurationMs = executorDurationMs + llmDurationMs;

            // Check if we can show Full Flow (has LLM or HITL data)
            const canShowFullFlow = hasLLM || hasHITL;
            const agentName = selectedExecution.agent_name || 'orchestrator';

            container.innerHTML = `
                <div class="dag-viz-container">
                    <div class="dag-viz-header">
                        <div class="dag-viz-title" onclick="this.classList.toggle('expanded')" title="Click to expand/collapse">${formatConversationRequest(selectedExecution.original_request || 'Unknown Request')}</div>
                        <div class="dag-viz-meta">
                            ${agentName !== 'orchestrator' ? `<span class="dag-viz-meta-item" style="color: var(--accent-purple);">🤖 ${escapeHtml(agentName)}</span>` : ''}
                            <span class="dag-viz-meta-item">ID: ${(selectedExecution.request_id || '').substring(0, 20)}...</span>
                            ${selectedExecution.trace_id ? `<span class="dag-viz-meta-item">Trace: ${selectedExecution.trace_id.substring(0, 16)}...</span>` : ''}
                            <span class="dag-viz-meta-item">${stepCount} step${stepCount !== 1 ? 's' : ''}</span>
                            <span class="dag-viz-meta-item">⏱️ Total: ${formatDuration(totalDurationMs)}</span>
                            <span class="dag-viz-meta-item ${selectedExecution.interrupted ? 'interrupted' : (selectedExecution.success ? 'success' : 'error')}">${selectedExecution.interrupted ? '⏸ Interrupted' : (selectedExecution.success ? '✓ Success' : '✗ Failed')}</span>
                            ${hasLLM ? `<span class="dag-viz-meta-item" style="color: var(--accent-blue);">💭 ${llmCallCount} LLM calls</span>` : ''}
                            ${hasHITL && !selectedExecution.interrupted ? `<span class="dag-viz-meta-item" style="color: var(--accent-orange);">⏸️ HITL</span>` : ''}
                            ${canShowFullFlow ? `
                            <div class="dag-view-toggle">
                                <button class="toggle-btn steps-btn ${dagViewMode === 'steps' ? 'active' : ''}" onclick="setDagViewMode('steps')">Steps Only</button>
                                <button class="toggle-btn full-btn ${dagViewMode === 'full' ? 'active' : ''}" onclick="setDagViewMode('full')">Full Flow</button>
                            </div>` : ''}
                        </div>
                    </div>
                    <div id="dagContainer" class="dag-viz-canvas"></div>
                    <div id="dagLegend" class="dag-viz-legend">
                        ${dagViewMode === 'full' ? `
                        <!-- Full Flow Legend -->
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot orchestrator"></span>
                            <span>Agent</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot llm-call"></span>
                            <span>LLM Call</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot diamond checkpoint"></span>
                            <span>Plan ✓</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot diamond checkpoint-before"></span>
                            <span>⏸️ Before</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot diamond checkpoint-after"></span>
                            <span>✓ After</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot diamond checkpoint-error"></span>
                            <span>⚠️ Error</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot completed"></span>
                            <span>Step (OK)</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot failed"></span>
                            <span>Step (Fail)</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot response"></span>
                            <span>Response</span>
                        </div>
                        ` : `
                        <!-- Steps Only Legend -->
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot completed"></span>
                            <span>Completed</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot failed"></span>
                            <span>Failed</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot pending"></span>
                            <span>Pending</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot blocked"></span>
                            <span>Blocked</span>
                        </div>
                        <div class="dag-legend-item">
                            <span class="dag-legend-dot skipped"></span>
                            <span>Skipped</span>
                        </div>
                        `}
                    </div>
                </div>`;

            // Initialize Cytoscape after DOM is ready
            setTimeout(() => initCytoscape(), 50);
        }

        // Set DAG view mode (Steps Only / Full Flow)
        function setDagViewMode(mode) {
            if (dagViewMode === mode) return;
            dagViewMode = mode;
            // Re-render the DAG visualization
            if (selectedExecution) {
                renderExecutionDetail();
            }
        }

        // Compute step levels using topological sort (for parallelism visualization)
        function computeStepLevels(steps) {
            if (!steps || steps.length === 0) return [];

            // Build in-degree map and adjacency list
            const inDegree = {};
            const dependents = {};

            steps.forEach(step => {
                inDegree[step.step_id] = (step.depends_on || []).length;
                dependents[step.step_id] = [];
            });

            steps.forEach(step => {
                (step.depends_on || []).forEach(dep => {
                    if (dependents[dep]) {
                        dependents[dep].push(step.step_id);
                    }
                });
            });

            // Kahn's algorithm for topological sort with level tracking
            const levels = [];
            let currentLevel = steps.filter(s => inDegree[s.step_id] === 0).map(s => s.step_id);

            while (currentLevel.length > 0) {
                levels.push(currentLevel);

                const nextLevel = [];
                currentLevel.forEach(stepId => {
                    (dependents[stepId] || []).forEach(dep => {
                        inDegree[dep]--;
                        if (inDegree[dep] === 0) {
                            nextLevel.push(dep);
                        }
                    });
                });
                currentLevel = nextLevel;
            }

            return levels;
        }

        // Update the DAG legend with parallelism statistics
        function updateDAGLegend(depth, maxParallelism) {
            const legendContainer = document.querySelector('.dag-viz-legend');
            if (!legendContainer) return;

            // Check if stats already exist
            let statsDiv = legendContainer.querySelector('.dag-stats');
            if (!statsDiv) {
                statsDiv = document.createElement('div');
                statsDiv.className = 'dag-stats';
                statsDiv.style.cssText = 'margin-left: auto; display: flex; gap: 16px; font-size: 11px; color: var(--text-muted);';
                legendContainer.appendChild(statsDiv);
            }

            statsDiv.innerHTML = `
                <span style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: var(--accent-teal);">↕</span>
                    Depth: ${depth}
                </span>
                <span style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: var(--accent-purple);">⇄</span>
                    Max Parallel: ${maxParallelism}
                </span>
            `;
        }

        function initCytoscape() {
            const dagContainer = document.getElementById('dagContainer');
            if (!dagContainer || !selectedExecution?.plan?.steps) return;

            // Helper to extract duration in ms from result (handles both duration_ms and duration in nanoseconds)
            const getDurationMs = (result) => {
                if (!result) return 0;
                if (result.duration_ms) return result.duration_ms;
                if (result.duration) return Math.round(result.duration / 1000000); // ns to ms
                return 0;
            };

            // Build step result lookup
            const stepResults = {};
            // First check result.steps (for completed executions)
            if (selectedExecution.result?.steps) {
                selectedExecution.result.steps.forEach(step => {
                    stepResults[step.step_id] = step;
                });
            }
            // Fall back to checkpoint.step_results for HITL-interrupted executions
            else if (selectedExecution.checkpoint?.step_results) {
                Object.values(selectedExecution.checkpoint.step_results).forEach(step => {
                    stepResults[step.step_id] = step;
                });
            }

            // Track the current step (blocked by HITL) for proper status display
            const currentStepId = selectedExecution.checkpoint?.current_step?.step_id;

            // Compute levels using topological sort for parallelism info
            const levels = computeStepLevels(selectedExecution.plan.steps);
            const maxParallelism = Math.max(...levels.map(l => l.length), 0);

            // Update legend with parallelism info (only for steps view)
            if (dagViewMode === 'steps') {
                updateDAGLegend(levels.length, maxParallelism);
            }

            let nodes = [];
            let edges = [];

            if (dagViewMode === 'full') {
                // === FULL FLOW MODE ===
                // Build complete execution flow: Orchestrator → LLM → [Checkpoint] → Steps → LLM → Response
                const agentName = selectedExecution.agent_name || 'orchestrator';
                const llmInteractions = selectedExecution.llm_interactions || [];
                const checkpoints = selectedExecution.hitl_checkpoints || [];

                // 1. Orchestrator node (root)
                nodes.push({
                    data: {
                        id: 'orchestrator',
                        label: `🤖 ${agentName}`,
                        nodeType: 'orchestrator'
                    }
                });

                // 2. LLM calls for planning phase (orchestrator-level calls without step_id)
                // Step-specific LLM calls (micro_resolution/semantic_retry WITH step_id) are handled separately in section 4c
                const planningTypes = ['tiered_selection', 'plan_generation', 'correction'];
                const planningCalls = llmInteractions.filter(i =>
                    planningTypes.includes(i.type) ||
                    (i.type === 'micro_resolution' && !i.step_id)  // Only orchestrator-level micro_resolution
                );
                planningCalls.forEach((call, idx) => {
                    const nodeId = `llm_plan_${idx}`;
                    const llmTypeLabels = {
                        'tiered_selection': 'Tier Select',
                        'micro_resolution': 'Resolution',
                        'plan_generation': 'Planning',
                        'correction': 'Plan Fix'
                    };
                    const llmType = llmTypeLabels[call.type] || call.type;
                    nodes.push({
                        data: {
                            id: nodeId,
                            label: `💭 ${llmType}`,
                            nodeType: 'llm_call',
                            llmType: call.type,
                            model: call.model || '',
                            duration: call.duration_ms || 0,
                            tokens: (call.prompt_tokens || 0) + (call.completion_tokens || 0)
                        }
                    });
                    // Connect to orchestrator or previous planning call
                    const source = idx === 0 ? 'orchestrator' : `llm_plan_${idx - 1}`;
                    edges.push({ data: { source, target: nodeId } });
                });

                // 3. HITL Checkpoints for plan approval
                const planCheckpoints = checkpoints.filter(c => c.interrupt_point === 'before_plan_execution');
                const lastPlanNode = planningCalls.length > 0 ? `llm_plan_${planningCalls.length - 1}` : 'orchestrator';

                planCheckpoints.forEach((cp, idx) => {
                    const nodeId = `checkpoint_plan_${idx}`;
                    const statusLabel = cp.status === 'approved' ? '✓' : cp.status === 'pending' ? '⏳' : '✗';
                    nodes.push({
                        data: {
                            id: nodeId,
                            label: `${statusLabel}`,
                            nodeType: 'checkpoint',
                            checkpointType: 'plan_approval',
                            status: cp.status
                        }
                    });
                    edges.push({ data: { source: lastPlanNode, target: nodeId } });
                });

                // 4. Step nodes (the DAG execution)
                const stepEntryNode = planCheckpoints.length > 0 ? `checkpoint_plan_${planCheckpoints.length - 1}` : lastPlanNode;

                // Find root steps (no dependencies)
                const rootSteps = selectedExecution.plan.steps.filter(s => !s.depends_on || s.depends_on.length === 0);

                // Compute step levels for parallelism info (reuse existing function)
                const fullFlowLevels = computeStepLevels(selectedExecution.plan.steps);

                selectedExecution.plan.steps.forEach(step => {
                    const result = stepResults[step.step_id];
                    // Determine step status: completed/failed/skipped from result, blocked if current HITL step, pending otherwise
                    let status = 'pending';
                    if (result) {
                        if (result.success) status = 'completed';
                        else if (result.error) status = 'failed';
                        else if (result.skipped) status = 'skipped';
                    } else if (currentStepId === step.step_id) {
                        status = 'blocked'; // Awaiting HITL approval
                    }
                    const stepCapability = step.metadata?.capability || result?.metadata?.capability || step.capability || step.agent_name || '';

                    // Find level and parallel info
                    const level = fullFlowLevels.findIndex(l => l.includes(step.step_id));
                    const parallelCount = level >= 0 ? fullFlowLevels[level].length : 1;

                    nodes.push({
                        data: {
                            id: step.step_id,
                            label: step.agent_name || stepCapability,
                            nodeType: 'step',
                            status: status,
                            duration: getDurationMs(result),
                            capability: stepCapability,
                            instruction: step.instruction || '',
                            level: level + 1,
                            parallelCount: parallelCount,
                            isParallel: parallelCount > 1,
                            dependsOn: step.depends_on || []
                        }
                    });
                });

                // Connect steps - root steps connect to entry point, others follow depends_on
                // If source step failed, mark the edge as failed to show broken data flow
                rootSteps.forEach(step => {
                    edges.push({ data: { source: stepEntryNode, target: step.step_id } });
                });
                selectedExecution.plan.steps.forEach(step => {
                    (step.depends_on || []).forEach(dep => {
                        const depResult = stepResults[dep];
                        const depFailed = depResult && !depResult.success;
                        edges.push({
                            data: {
                                source: dep,
                                target: step.step_id,
                                edgeType: depFailed ? 'failed' : undefined
                            }
                        });
                    });
                });

                // Create stepIds set early (needed by step-level checkpoints and LLM calls)
                const stepIds = new Set(selectedExecution.plan.steps.map(s => s.step_id));

                // 4b. HITL Step-level checkpoints (before_step, after_step, on_error)
                // These checkpoints are associated with specific steps via current_step.step_id
                const stepCheckpoints = checkpoints.filter(c =>
                    ['before_step', 'after_step', 'on_error'].includes(c.interrupt_point)
                );
                stepCheckpoints.forEach((cp, idx) => {
                    const nodeId = `checkpoint_step_${idx}`;
                    const parentStepId = cp.current_step?.step_id;

                    // Determine visual label based on interrupt point
                    let statusIcon, checkpointLabel;
                    switch (cp.interrupt_point) {
                        case 'before_step':
                            statusIcon = cp.status === 'approved' ? '▶' : cp.status === 'pending' ? '⏸️' : '⏹';
                            checkpointLabel = 'Before';
                            break;
                        case 'after_step':
                            statusIcon = cp.status === 'approved' ? '✓' : cp.status === 'pending' ? '⏳' : '✗';
                            checkpointLabel = 'After';
                            break;
                        case 'on_error':
                            statusIcon = cp.status === 'approved' ? '🔧' : cp.status === 'pending' ? '⚠️' : '❌';
                            checkpointLabel = 'Error';
                            break;
                        default:
                            statusIcon = '◯';
                            checkpointLabel = cp.interrupt_point;
                    }

                    nodes.push({
                        data: {
                            id: nodeId,
                            label: `${statusIcon}`,
                            nodeType: 'checkpoint',
                            checkpointType: cp.interrupt_point,
                            checkpointLabel: checkpointLabel,
                            status: cp.status,
                            parentStepId: parentStepId,
                            checkpointId: cp.checkpoint_id,
                            message: cp.message || '',
                            reason: cp.reason || ''
                        }
                    });

                    // Connect to parent step if available
                    if (parentStepId && stepIds.has(parentStepId)) {
                        // For before_step: edge from step to checkpoint (shows pause before execution)
                        // For after_step/on_error: edge from checkpoint to step (shows checkpoint after execution)
                        if (cp.interrupt_point === 'before_step') {
                            // Insert checkpoint between the step's dependencies and the step
                            // We need to re-route: instead of dep -> step, do dep -> checkpoint -> step
                            // For simplicity, we'll show it as a child of the step with a dashed line
                            edges.push({ data: { source: parentStepId, target: nodeId, edgeType: 'checkpoint' } });
                        } else {
                            // after_step and on_error: show as child of the step
                            edges.push({ data: { source: parentStepId, target: nodeId, edgeType: 'checkpoint' } });
                        }
                    }
                });

                // 4c. Step-specific LLM calls (micro_resolution and semantic_retry WITH step_id)
                // These are parameter resolution calls associated with specific execution steps
                const stepSpecificLLMCalls = llmInteractions.filter(i =>
                    ['micro_resolution', 'semantic_retry'].includes(i.type) && i.step_id
                );
                stepSpecificLLMCalls.forEach((call, idx) => {
                    const nodeId = `llm_step_${idx}`;
                    const parentStepId = call.step_id;
                    const llmTypeLabels = {
                        'micro_resolution': '🔍 Resolution',
                        'semantic_retry': '🔄 Retry'
                    };
                    const llmType = llmTypeLabels[call.type] || call.type;

                    nodes.push({
                        data: {
                            id: nodeId,
                            label: llmType,
                            nodeType: 'llm_step',
                            llmType: call.type,
                            parentStepId: parentStepId,
                            model: call.model || '',
                            duration: call.duration_ms || 0,
                            tokens: (call.prompt_tokens || 0) + (call.completion_tokens || 0),
                            success: call.success !== false,
                            error: call.error || ''
                        }
                    });

                    // Connect to parent step
                    if (parentStepId && stepIds.has(parentStepId)) {
                        edges.push({ data: { source: parentStepId, target: nodeId, edgeType: 'llm_step' } });
                    }
                });

                // 5. Find leaf steps (no dependents)
                // Note: stepIds already defined above for use by checkpoints and LLM calls
                const dependents = new Set();
                selectedExecution.plan.steps.forEach(step => {
                    (step.depends_on || []).forEach(dep => dependents.add(dep));
                });
                const leafSteps = selectedExecution.plan.steps.filter(s => !dependents.has(s.step_id) ||
                    !selectedExecution.plan.steps.some(other => (other.depends_on || []).includes(s.step_id)));

                // 6. LLM calls for synthesis (includes synthesis and synthesis_streaming)
                const synthesisCalls = llmInteractions.filter(i => i.type === 'synthesis' || i.type === 'synthesis_streaming');
                if (synthesisCalls.length > 0) {
                    synthesisCalls.forEach((call, idx) => {
                        const nodeId = `llm_synth_${idx}`;
                        const isStreaming = call.type === 'synthesis_streaming';
                        nodes.push({
                            data: {
                                id: nodeId,
                                label: isStreaming ? '💭 Synthesis (Stream)' : '💭 Synthesis',
                                nodeType: 'llm_call',
                                llmType: call.type,
                                model: call.model || '',
                                duration: call.duration_ms || 0,
                                tokens: (call.prompt_tokens || 0) + (call.completion_tokens || 0)
                            }
                        });
                        // Connect leaf steps to synthesis
                        // Failed steps get dashed red edges to show they didn't contribute data
                        if (idx === 0) {
                            leafSteps.forEach(step => {
                                const result = stepResults[step.step_id];
                                const isFailed = result && !result.success;
                                edges.push({
                                    data: {
                                        source: step.step_id,
                                        target: nodeId,
                                        edgeType: isFailed ? 'failed' : undefined
                                    }
                                });
                            });
                        } else {
                            edges.push({ data: { source: `llm_synth_${idx - 1}`, target: nodeId } });
                        }
                    });
                }

                // 7. Response node
                const responseSource = synthesisCalls.length > 0 ? `llm_synth_${synthesisCalls.length - 1}` :
                    (leafSteps.length > 0 ? leafSteps[0].step_id : stepEntryNode);
                const successLabel = selectedExecution.success ? '✓ Complete' : '✗ Failed';
                nodes.push({
                    data: {
                        id: 'response',
                        label: `📤 ${successLabel}`,
                        nodeType: 'response',
                        success: selectedExecution.success
                    }
                });
                if (synthesisCalls.length > 0) {
                    edges.push({ data: { source: responseSource, target: 'response' } });
                } else {
                    // No synthesis - connect leaf steps directly to response
                    // Failed steps get dashed red edges
                    leafSteps.forEach(step => {
                        const result = stepResults[step.step_id];
                        const isFailed = result && !result.success;
                        edges.push({
                            data: {
                                source: step.step_id,
                                target: 'response',
                                edgeType: isFailed ? 'failed' : undefined
                            }
                        });
                    });
                }

            } else {
                // === STEPS ONLY MODE (original behavior) ===
                nodes = selectedExecution.plan.steps.map(step => {
                    const result = stepResults[step.step_id];
                    // Determine step status: completed/failed/skipped from result, blocked if current HITL step, pending otherwise
                    let status = 'pending';
                    if (result) {
                        if (result.success) status = 'completed';
                        else if (result.error) status = 'failed';
                        else if (result.skipped) status = 'skipped';
                    } else if (currentStepId === step.step_id) {
                        status = 'blocked'; // Awaiting HITL approval
                    }

                    // Find the level (depth) of this step
                    const level = levels.findIndex(l => l.includes(step.step_id));
                    const parallelCount = level >= 0 ? levels[level].length : 1;
                    const isParallel = parallelCount > 1;

                    // Get capability from metadata (where orchestration stores it)
                    const stepCapability = step.metadata?.capability || result?.metadata?.capability || step.capability || step.agent_name || '';

                    return {
                        data: {
                            id: step.step_id,
                            label: step.agent_name || stepCapability,
                            capability: stepCapability,
                            instruction: step.instruction || '',
                            status: status,
                            duration: getDurationMs(result),
                            level: level + 1,
                            parallelCount: parallelCount,
                            isParallel: isParallel,
                            dependsOn: step.depends_on || []
                        }
                    };
                });

                // Build edges for steps mode
                // If source step failed, mark the edge as failed to show broken data flow
                selectedExecution.plan.steps.forEach(step => {
                    (step.depends_on || []).forEach(dep => {
                        const depResult = stepResults[dep];
                        const depFailed = depResult && !depResult.success;
                        edges.push({
                            data: {
                                source: dep,
                                target: step.step_id,
                                edgeType: depFailed ? 'failed' : undefined
                            }
                        });
                    });
                });
            }

            // Destroy existing instance if any
            if (cyInstance) {
                cyInstance.destroy();
            }

            // Create Cytoscape instance with premium dark styling
            cyInstance = cytoscape({
                container: dagContainer,
                elements: { nodes, edges },
                style: [
                    {
                        // Base node style - glassy dark look
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'background-color': '#151820',
                            'background-opacity': 0.7,
                            'color': '#e8eaed',
                            'font-size': '11px',
                            'font-weight': '500',
                            'font-family': '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
                            'width': '150px',
                            'height': '46px',
                            'shape': 'round-rectangle',
                            'text-wrap': 'wrap',
                            'text-max-width': '130px',
                            'border-width': '1px',
                            'border-color': '#3a4556',
                            'border-opacity': 0.8,
                            'text-outline-color': '#0d1117',
                            'text-outline-width': '1px',
                            'overlay-padding': '6px',
                            'z-index': 10
                        }
                    },
                    {
                        // Completed - glassy green tint
                        selector: 'node[status="completed"]',
                        style: {
                            'background-color': '#0f2818',
                            'background-opacity': 0.65,
                            'border-color': '#32d74b',
                            'border-width': '2px',
                            'border-opacity': 0.9,
                            'color': '#32d74b'
                        }
                    },
                    {
                        // Failed - glassy red tint
                        selector: 'node[status="failed"]',
                        style: {
                            'background-color': '#2a0f0f',
                            'background-opacity': 0.65,
                            'border-color': '#ff6b6b',
                            'border-width': '2px',
                            'border-opacity': 0.9,
                            'color': '#ff6b6b'
                        }
                    },
                    {
                        // Pending - glassy amber tint
                        selector: 'node[status="pending"]',
                        style: {
                            'background-color': '#2a1f0a',
                            'background-opacity': 0.65,
                            'border-color': '#ffb340',
                            'border-width': '2px',
                            'border-opacity': 0.9,
                            'color': '#ffb340'
                        }
                    },
                    {
                        // Skipped - glassy muted gray
                        selector: 'node[status="skipped"]',
                        style: {
                            'background-color': '#12151a',
                            'background-opacity': 0.5,
                            'border-color': '#3a4556',
                            'border-width': '1px',
                            'border-opacity': 0.6,
                            'color': '#6b7280'
                        }
                    },
                    {
                        // Blocked - glassy blue tint (awaiting HITL approval)
                        selector: 'node[status="blocked"]',
                        style: {
                            'background-color': '#0a1a2e',
                            'background-opacity': 0.65,
                            'border-color': '#0a84ff',
                            'border-width': '3px',
                            'border-style': 'dashed',
                            'border-opacity': 0.9,
                            'color': '#0a84ff'
                        }
                    },
                    {
                        // Selected - glassy blue highlight
                        selector: 'node:selected',
                        style: {
                            'border-width': '2px',
                            'border-color': '#0a84ff',
                            'border-opacity': 1,
                            'background-color': '#0a1a2e',
                            'background-opacity': 0.8,
                            'color': '#ffffff'
                        }
                    },
                    {
                        selector: 'node:active',
                        style: {
                            'overlay-color': '#0a84ff',
                            'overlay-opacity': 0.2
                        }
                    },
                    {
                        // Edges - subtle teal lines
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#3d5a6e',
                            'target-arrow-color': '#64d2ff',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.2,
                            'line-opacity': 0.8
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'line-color': '#0a84ff',
                            'target-arrow-color': '#0a84ff',
                            'width': 3
                        }
                    },
                    // === Full Flow Node Types ===
                    {
                        // Orchestrator Agent - purple hexagon style
                        selector: 'node[nodeType="orchestrator"]',
                        style: {
                            'background-color': '#3d1a4d',
                            'border-color': '#da8fff',
                            'border-width': '2px',
                            'color': '#ffffff',
                            'shape': 'round-rectangle',
                            'width': '160px',
                            'height': '50px'
                        }
                    },
                    {
                        // LLM Call - blue pill
                        selector: 'node[nodeType="llm_call"]',
                        style: {
                            'background-color': '#1a3a5c',
                            'border-color': '#0a84ff',
                            'border-width': '2px',
                            'color': '#ffffff',
                            'shape': 'round-rectangle',
                            'width': '140px',
                            'height': '44px'
                        }
                    },
                    {
                        // Step-specific LLM Call - teal pill (micro_resolution attached to step)
                        selector: 'node[nodeType="llm_step"][llmType="micro_resolution"]',
                        style: {
                            'background-color': '#0d3d4d',
                            'border-color': '#64d2ff',
                            'border-width': '2px',
                            'color': '#ffffff',
                            'shape': 'round-rectangle',
                            'width': '120px',
                            'height': '36px'
                        }
                    },
                    {
                        // Step-specific LLM Call - pink pill (semantic_retry attached to step)
                        selector: 'node[nodeType="llm_step"][llmType="semantic_retry"]',
                        style: {
                            'background-color': '#4d1a3d',
                            'border-color': '#ff6eb4',
                            'border-width': '2px',
                            'color': '#ffffff',
                            'shape': 'round-rectangle',
                            'width': '120px',
                            'height': '36px'
                        }
                    },
                    {
                        // HITL Checkpoint - default orange diamond style (plan approval)
                        selector: 'node[nodeType="checkpoint"]',
                        style: {
                            'background-color': '#4d3a1a',
                            'border-color': '#ffb340',
                            'border-width': '2px',
                            'color': '#ffffff',
                            'shape': 'diamond',
                            'width': '80px',
                            'height': '80px',
                            'text-valign': 'center',
                            'font-size': '10px'
                        }
                    },
                    {
                        // HITL Step Checkpoint - before_step (gold/pause)
                        selector: 'node[checkpointType="before_step"]',
                        style: {
                            'background-color': '#4d4a1a',
                            'border-color': '#ffd60a',
                            'width': '60px',
                            'height': '60px',
                            'font-size': '14px'
                        }
                    },
                    {
                        // HITL Step Checkpoint - after_step (green/complete)
                        selector: 'node[checkpointType="after_step"]',
                        style: {
                            'background-color': '#1a4d2e',
                            'border-color': '#30d158',
                            'width': '60px',
                            'height': '60px',
                            'font-size': '14px'
                        }
                    },
                    {
                        // HITL Step Checkpoint - on_error (red/warning)
                        selector: 'node[checkpointType="on_error"]',
                        style: {
                            'background-color': '#4d1a1a',
                            'border-color': '#ff453a',
                            'width': '60px',
                            'height': '60px',
                            'font-size': '14px'
                        }
                    },
                    {
                        // Checkpoint edge style (dashed line)
                        selector: 'edge[edgeType="checkpoint"]',
                        style: {
                            'line-style': 'dashed',
                            'line-dash-pattern': [6, 3],
                            'line-color': '#ffb340',
                            'target-arrow-color': '#ffb340',
                            'opacity': 0.7
                        }
                    },
                    {
                        // Step-specific LLM edge style (dotted teal line)
                        selector: 'edge[edgeType="llm_step"]',
                        style: {
                            'line-style': 'dotted',
                            'line-dash-pattern': [3, 3],
                            'line-color': '#64d2ff',
                            'target-arrow-color': '#64d2ff',
                            'opacity': 0.8
                        }
                    },
                    {
                        // Failed step edge style (dashed red line with X marker)
                        selector: 'edge[edgeType="failed"]',
                        style: {
                            'line-style': 'dashed',
                            'line-dash-pattern': [4, 4],
                            'line-color': '#ff6b6b',
                            'target-arrow-color': '#ff6b6b',
                            'opacity': 0.6,
                            'width': 1.5
                        }
                    },
                    {
                        // Response - teal rounded rectangle
                        selector: 'node[nodeType="response"]',
                        style: {
                            'background-color': '#1a4d4d',
                            'border-color': '#64d2ff',
                            'border-width': '2px',
                            'color': '#ffffff',
                            'shape': 'round-rectangle',
                            'width': '140px',
                            'height': '44px'
                        }
                    },
                    {
                        // Execution phase container (visual grouping)
                        selector: 'node[nodeType="step"]',
                        style: {
                            'width': '150px',
                            'height': '46px'
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'TB',
                    nodeSep: 80,
                    rankSep: 100,
                    padding: 50
                },
                // Enable better rendering
                minZoom: 0.3,
                maxZoom: 2,
                wheelSensitivity: 0.3
            });

            // Add click handler for nodes
            cyInstance.on('tap', 'node', function(evt) {
                const node = evt.target;
                const nodeData = node.data();
                const nodeType = nodeData.nodeType;

                // Handle different node types in full flow mode
                if (nodeType === 'orchestrator' || nodeType === 'llm_call' || nodeType === 'llm_step' || nodeType === 'checkpoint' || nodeType === 'response') {
                    showFullFlowNodePopup(node, nodeData);
                } else {
                    // Step node - use existing logic
                    const stepId = node.id();
                    const result = stepResults[stepId];
                    const step = selectedExecution.plan.steps.find(s => s.step_id === stepId);
                    showNodePopup(node, step, result);
                }
            });

            // Close popup when clicking on background (canvas)
            cyInstance.on('tap', function(evt) {
                if (evt.target === cyInstance) {
                    // Clicked on background, not a node
                    document.querySelectorAll('.node-popup').forEach(p => p.remove());
                }
            });
        }

        // Popup for Full Flow node types (orchestrator, llm_call, checkpoint, response)
        function showFullFlowNodePopup(node, nodeData) {
            document.querySelectorAll('.node-popup').forEach(p => p.remove());

            const nodeType = nodeData.nodeType;
            let title, content, color;

            switch (nodeType) {
                case 'orchestrator':
                    title = '🤖 Orchestrator Agent';
                    color = 'var(--accent-purple)';
                    const agentName = selectedExecution.agent_name || 'orchestrator';
                    content = `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Agent Name</div>
                            <div style="font-weight: 500;">${escapeHtml(agentName)}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Request ID</div>
                            <div style="font-family: 'SF Mono', monospace; font-size: 11px;">${selectedExecution.request_id}</div>
                        </div>
                    `;
                    break;
                case 'llm_call':
                    title = '💭 LLM Call';
                    color = 'var(--accent-blue)';
                    const llmType = nodeData.llmType || 'unknown';
                    const model = nodeData.model || 'unknown';
                    const duration = nodeData.duration || 0;
                    const tokens = nodeData.tokens || 0;
                    // Format type for display (capitalize and replace underscores)
                    const formattedType = llmType.replace(/_/g, ' ').toUpperCase();
                    content = `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Type</div>
                            <span style="
                                display: inline-block;
                                padding: 4px 12px;
                                background: linear-gradient(135deg, rgba(0, 210, 211, 0.2) 0%, rgba(0, 210, 211, 0.1) 100%);
                                border: 1px solid rgba(0, 210, 211, 0.4);
                                border-radius: 6px;
                                font-size: 11px;
                                font-weight: 600;
                                color: #00d2d3;
                                letter-spacing: 0.5px;
                            ">${escapeHtml(formattedType)}</span>
                        </div>
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Model</div>
                            <span style="
                                display: inline-block;
                                padding: 4px 12px;
                                background: linear-gradient(135deg, rgba(165, 94, 234, 0.2) 0%, rgba(165, 94, 234, 0.1) 100%);
                                border: 1px solid rgba(165, 94, 234, 0.4);
                                border-radius: 6px;
                                font-family: 'SF Mono', monospace;
                                font-size: 11px;
                                font-weight: 500;
                                color: #d4a5ff;
                            ">${escapeHtml(model)}</span>
                        </div>
                        ${duration > 0 ? `
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Duration</div>
                            <div>${formatDuration(duration)}</div>
                        </div>` : ''}
                        ${tokens > 0 ? `
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Tokens</div>
                            <div>${tokens.toLocaleString()}</div>
                        </div>` : ''}
                    `;
                    break;
                case 'llm_step':
                    // Step-specific LLM call (micro_resolution or semantic_retry attached to a step)
                    const stepLlmType = nodeData.llmType || 'unknown';
                    const stepLlmTypeLabel = stepLlmType === 'micro_resolution' ? '🔍 Parameter Resolution' :
                                             stepLlmType === 'semantic_retry' ? '🔄 Semantic Retry' : stepLlmType;
                    title = stepLlmTypeLabel;
                    color = stepLlmType === 'micro_resolution' ? 'var(--accent-teal)' : 'var(--accent-pink)';
                    const stepLlmModel = nodeData.model || 'unknown';
                    const stepLlmDuration = nodeData.duration || 0;
                    const stepLlmTokens = nodeData.tokens || 0;
                    const parentStepId = nodeData.parentStepId || '';
                    const stepLlmSuccess = nodeData.success !== false;
                    const stepLlmError = nodeData.error || '';

                    // Find parent step info
                    const parentStep = selectedExecution.plan.steps.find(s => s.step_id === parentStepId);
                    const parentStepLabel = parentStep ? (parentStep.agent_name || parentStep.metadata?.capability || parentStepId) : parentStepId;

                    content = `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Parent Step</div>
                            <span style="
                                display: inline-block;
                                padding: 4px 12px;
                                background: linear-gradient(135deg, rgba(50, 215, 75, 0.2) 0%, rgba(50, 215, 75, 0.1) 100%);
                                border: 1px solid rgba(50, 215, 75, 0.4);
                                border-radius: 6px;
                                font-size: 11px;
                                font-weight: 500;
                                color: #32d74b;
                            ">${escapeHtml(parentStepLabel)}</span>
                        </div>
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Model</div>
                            <span style="
                                display: inline-block;
                                padding: 4px 12px;
                                background: linear-gradient(135deg, rgba(165, 94, 234, 0.2) 0%, rgba(165, 94, 234, 0.1) 100%);
                                border: 1px solid rgba(165, 94, 234, 0.4);
                                border-radius: 6px;
                                font-family: 'SF Mono', monospace;
                                font-size: 11px;
                                font-weight: 500;
                                color: #d4a5ff;
                            ">${escapeHtml(stepLlmModel)}</span>
                        </div>
                        ${!stepLlmSuccess ? `
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--accent-red); font-weight: 600;">⚠️ Failed</div>
                            ${stepLlmError ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(stepLlmError)}</div>` : ''}
                        </div>` : ''}
                        ${stepLlmDuration > 0 ? `
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Duration</div>
                            <div>${formatDuration(stepLlmDuration)}</div>
                        </div>` : ''}
                        ${stepLlmTokens > 0 ? `
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Tokens</div>
                            <div>${stepLlmTokens.toLocaleString()}</div>
                        </div>` : ''}
                    `;
                    break;
                case 'checkpoint':
                    const cpType = nodeData.checkpointType || 'unknown';
                    const cpStatus = nodeData.status || 'unknown';
                    const cpLabel = nodeData.checkpointLabel || cpType.replace(/_/g, ' ');
                    const cpParentStep = nodeData.parentStepId || '';
                    const cpMessage = nodeData.message || '';
                    const cpReason = nodeData.reason || '';

                    // Set title and color based on checkpoint type
                    const isStepLevel = ['before_step', 'after_step', 'on_error'].includes(cpType);
                    if (cpType === 'before_step') {
                        title = '⏸️ Before Step';
                        color = 'var(--accent-purple)';
                    } else if (cpType === 'after_step') {
                        title = '✓ After Step';
                        color = 'var(--accent-green)';
                    } else if (cpType === 'on_error') {
                        title = '⚠️ On Error';
                        color = 'var(--accent-red)';
                    } else {
                        title = '⏸️ HITL Checkpoint';
                        color = 'var(--accent-orange)';
                    }

                    const statusColor = cpStatus === 'approved' ? 'var(--accent-green)' :
                                       cpStatus === 'rejected' ? 'var(--accent-red)' : 'var(--accent-orange)';
                    content = `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Type</div>
                            <div style="font-weight: 500;">${escapeHtml(cpLabel)}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Status</div>
                            <div style="color: ${statusColor}; font-weight: 600;">${escapeHtml(cpStatus.toUpperCase())}</div>
                        </div>
                        ${cpParentStep ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Parent Step</div>
                            <div class="mono" style="font-size: 12px; color: var(--accent-blue);">${escapeHtml(cpParentStep)}</div>
                        </div>` : ''}
                        ${cpReason ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Reason</div>
                            <div style="font-size: 12px;">${escapeHtml(cpReason)}</div>
                        </div>` : ''}
                        ${cpMessage ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Message</div>
                            <div style="font-size: 12px; max-width: 200px; word-wrap: break-word;">${escapeHtml(cpMessage)}</div>
                        </div>` : ''}
                    `;
                    break;
                case 'response':
                    title = '📤 Response';
                    color = 'var(--accent-teal)';
                    const success = nodeData.success;
                    const resultColor = success ? 'var(--accent-green)' : 'var(--accent-red)';
                    // Compute total duration: executor time + LLM time
                    const responseTotalDuration = (selectedExecution.total_duration_ms || 0) + (selectedExecution.llm_debug_summary?.total_duration_ms || 0);
                    content = `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Status</div>
                            <div style="color: ${resultColor}; font-weight: 600;">${success ? 'SUCCESS' : 'FAILED'}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Total Duration</div>
                            <div>${formatDuration(responseTotalDuration)}</div>
                        </div>
                    `;
                    break;
                case 'step':
                    // Handle step nodes in Full Flow mode
                    const stepStatus = nodeData.status || 'pending';
                    const stepStatusColor = stepStatus === 'completed' ? 'var(--accent-green)' :
                                           stepStatus === 'failed' ? 'var(--accent-red)' :
                                           stepStatus === 'skipped' ? 'var(--text-muted)' :
                                           stepStatus === 'blocked' ? '#ff3b30' : 'var(--accent-orange)';
                    title = `🔧 ${escapeHtml(nodeData.label || 'Step')}`;
                    color = stepStatusColor;
                    const stepLevel = nodeData.level || 1;
                    const stepParallel = nodeData.parallelCount || 1;
                    const stepDeps = nodeData.dependsOn || [];
                    content = `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Status</div>
                            <div style="color: ${stepStatusColor}; font-weight: 600;">${stepStatus.toUpperCase()}</div>
                        </div>
                        ${nodeData.capability ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Capability</div>
                            <div style="font-family: 'SF Mono', monospace; font-size: 11px;">${escapeHtml(nodeData.capability)}</div>
                        </div>` : ''}
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Level</div>
                            <div>Level ${stepLevel} ${stepParallel > 1 ? `<span style="color: var(--accent-purple);">(${stepParallel} parallel)</span>` : '(sequential)'}</div>
                        </div>
                        ${nodeData.duration > 0 ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Duration</div>
                            <div>${formatDuration(nodeData.duration)}</div>
                        </div>` : ''}
                        ${stepDeps.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Depends On</div>
                            <div style="font-family: 'SF Mono', monospace; font-size: 10px;">${stepDeps.join(', ')}</div>
                        </div>` : ''}
                        ${nodeData.instruction ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 11px; color: var(--text-muted);">Instruction</div>
                            <div style="font-size: 11px; max-height: 60px; overflow-y: auto;">${escapeHtml(nodeData.instruction).substring(0, 150)}${nodeData.instruction.length > 150 ? '...' : ''}</div>
                        </div>` : ''}
                    `;
                    break;
                default:
                    return;
            }

            const popup = document.createElement('div');
            popup.className = 'node-popup';
            popup.style.cssText = `
                position: absolute;
                background: linear-gradient(135deg, rgba(25, 25, 35, 0.98) 0%, rgba(15, 15, 22, 0.98) 100%);
                backdrop-filter: blur(24px) saturate(180%);
                -webkit-backdrop-filter: blur(24px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 16px;
                padding: 18px 20px;
                max-width: 380px;
                min-width: 280px;
                z-index: 1000;
                font-size: 13px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                            0 8px 24px rgba(0, 0, 0, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.1),
                            inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            `;

            popup.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: ${color};">${title}</div>
                </div>
                ${content}
            `;

            // Position popup near node
            const dagContainer = document.getElementById('dagContainer');
            const pos = node.renderedPosition();
            const containerRect = dagContainer.getBoundingClientRect();
            popup.style.left = Math.min(pos.x + 80, containerRect.width - 260) + 'px';
            popup.style.top = Math.max(pos.y - 80, 10) + 'px';

            dagContainer.appendChild(popup);
        }

        function showNodePopup(node, step, result) {
            // Remove existing popups
            document.querySelectorAll('.node-popup').forEach(p => p.remove());

            const status = result ? (result.success ? 'completed' : 'failed') : 'pending';
            const statusColor = status === 'completed' ? 'var(--accent-green)' :
                               status === 'failed' ? 'var(--accent-red)' : 'var(--accent-orange)';

            // Get parallelism info from node data
            const nodeData = node.data();
            const level = nodeData.level || 1;
            const parallelCount = nodeData.parallelCount || 1;
            const isParallel = nodeData.isParallel || false;
            const dependsOn = nodeData.dependsOn || step.depends_on || [];
            // Get capability from metadata (where orchestration stores it)
            const capability = step.metadata?.capability || result?.metadata?.capability || step.capability || step.agent_name || '';

            const popup = document.createElement('div');
            popup.className = 'node-popup';
            popup.style.cssText = `
                position: absolute;
                background: linear-gradient(135deg, rgba(25, 25, 35, 0.98) 0%, rgba(15, 15, 22, 0.98) 100%);
                backdrop-filter: blur(24px) saturate(180%);
                -webkit-backdrop-filter: blur(24px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 16px;
                padding: 18px 20px;
                max-width: 380px;
                min-width: 280px;
                z-index: 1000;
                font-size: 13px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                            0 8px 24px rgba(0, 0, 0, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.1),
                            inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            `;

            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 13px; color: var(--accent-teal);">${step.agent_name || capability}</span>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">
                        ${status.toUpperCase()}
                    </span>
                </div>
                ${capability && capability !== step.agent_name ? `
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">
                        <span style="color: var(--accent-purple);">⚡</span> ${capability}
                    </div>
                ` : ''}
                <div style="color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5;">${step.instruction || 'No instruction'}</div>

                <!-- Execution Flow Info -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;">
                    <span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; background: rgba(10, 132, 255, 0.15); color: var(--accent-blue); font-family: 'SF Mono', 'Monaco', monospace;">
                        ${step.step_id}
                    </span>
                    <span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; background: rgba(100, 210, 255, 0.15); color: var(--accent-teal);">
                        Level ${level}
                    </span>
                    ${isParallel ? `
                        <span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; background: rgba(218, 143, 255, 0.15); color: var(--accent-purple);">
                            ⇄ ${parallelCount} parallel
                        </span>
                    ` : `
                        <span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; background: rgba(255, 179, 64, 0.15); color: var(--accent-orange);">
                            ↓ Sequential
                        </span>
                    `}
                    ${dependsOn.length > 0 ? `
                        <span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; background: rgba(255, 255, 255, 0.08); color: var(--text-muted);">
                            ← ${dependsOn.length} dep${dependsOn.length > 1 ? 's' : ''}
                        </span>
                    ` : `
                        <span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; background: rgba(50, 215, 75, 0.15); color: var(--accent-green);">
                            ○ Root step
                        </span>
                    `}
                </div>

                ${dependsOn.length > 0 ? `
                    <div style="margin-bottom: 12px; padding: 8px 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 11px;">
                        <span style="color: var(--text-muted);">Depends on:</span>
                        <span style="color: var(--text-secondary); margin-left: 6px;">${dependsOn.join(', ')}</span>
                    </div>
                ` : ''}

                ${result ? `
                    <div style="display: flex; gap: 14px; padding: 10px 12px; background: rgba(0,0,0,0.25); border-radius: 8px; color: var(--text-muted); font-size: 11px;">
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <span style="color: ${result.success ? 'var(--accent-green)' : 'var(--accent-red)'};">${result.success ? '✓' : '✗'}</span>
                            ${result.success ? 'Success' : 'Failed'}
                        </span>
                        <span>${formatDuration(result.duration_ms || (result.duration ? Math.round(result.duration / 1000000) : 0))}</span>
                        <span>${result.attempts || 1} attempt${(result.attempts || 1) > 1 ? 's' : ''}</span>
                    </div>
                    ${result.error ? `
                        <div style="margin-top: 10px; padding: 10px 12px; background: rgba(255, 107, 107, 0.1); border-radius: 8px; border: 1px solid rgba(255, 107, 107, 0.2); color: var(--accent-red); font-size: 11px;">
                            ${result.error}
                        </div>
                    ` : ''}
                ` : '<div style="color: var(--text-muted); font-style: italic;">Not executed yet</div>'}
            `;

            const container = document.getElementById('dagContainer');
            const pos = node.renderedPosition();
            popup.style.left = (pos.x + 80) + 'px';
            popup.style.top = (pos.y - 60) + 'px';

            container.appendChild(popup);

            // Close on click outside
            const closeHandler = (e) => {
                if (!popup.contains(e.target)) {
                    popup.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => document.addEventListener('click', closeHandler), 100);
        }

        function formatResponseJson(response) {
            if (!response) return '';
            try {
                // Handle string responses that might be JSON
                let data = response;
                if (typeof response === 'string') {
                    // Try to parse as JSON
                    try {
                        data = JSON.parse(response);
                    } catch {
                        // Not JSON, return as-is but escape HTML, wrapped in pre
                        const escaped = response.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        return `<pre style="margin: 0; white-space: pre-wrap; word-break: break-word; text-align: left;">${escaped}</pre>`;
                    }
                }
                // Pretty print and syntax highlight, wrapped in pre for proper formatting
                const highlighted = syntaxHighlightJson(data);
                return `<pre style="margin: 0; white-space: pre-wrap; word-break: break-word; text-align: left;">${highlighted}</pre>`;
            } catch (e) {
                const escaped = String(response).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<pre style="margin: 0; white-space: pre-wrap; word-break: break-word; text-align: left;">${escaped}</pre>`;
            }
        }

        function toggleStepResponse(stepId) {
            const content = document.getElementById(`step-response-${stepId}`);
            const header = content?.previousElementSibling;
            if (content) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                if (header) {
                    const arrow = header.querySelector('.expand-arrow');
                    if (arrow) arrow.textContent = isHidden ? '▼' : '▶';
                }
            }
        }

        function toggleCapabilityJson(elementId) {
            const content = document.getElementById(elementId);
            if (content) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                // Update arrow - extract index from elementId (e.g., 'cap-json-0' -> '0')
                const idx = elementId.replace('cap-json-', '');
                const arrow = document.getElementById(`cap-arrow-${idx}`);
                if (arrow) arrow.textContent = isHidden ? '▼' : '▶';
            }
        }

        function renderStepDetails(container) {
            if (!selectedExecution?.plan?.steps) {
                container.innerHTML = '<div class="empty-detail">No steps available</div>';
                return;
            }

            const stepResults = {};
            // First check result.steps (for completed executions)
            if (selectedExecution.result?.steps) {
                selectedExecution.result.steps.forEach(step => {
                    stepResults[step.step_id] = step;
                });
            }
            // Fall back to checkpoint.step_results for HITL-interrupted executions
            else if (selectedExecution.checkpoint?.step_results) {
                Object.values(selectedExecution.checkpoint.step_results).forEach(step => {
                    stepResults[step.step_id] = step;
                });
            }

            // Track the current step (blocked by HITL) for proper status display
            const currentStepId = selectedExecution.checkpoint?.current_step?.step_id;

            // Build reverse dependency map (which steps depend on each step)
            const usedByMap = {};
            selectedExecution.plan.steps.forEach(step => {
                usedByMap[step.step_id] = [];
            });
            selectedExecution.plan.steps.forEach(step => {
                (step.depends_on || []).forEach(dep => {
                    if (usedByMap[dep]) {
                        usedByMap[dep].push(step.step_id);
                    }
                });
            });

            // Helper to validate a timestamp is real (not Go's zero time "0001-01-01T00:00:00Z")
            const isValidTimestamp = (timestamp) => {
                if (!timestamp) return false;
                const date = new Date(timestamp);
                // Check if date is valid and after year 2020 (reasonable minimum)
                return !isNaN(date.getTime()) && date.getFullYear() > 2020;
            };

            // Helper to calculate wait time for a step
            // Wait time = step.start_time - max(dependency.end_time for all dependencies)
            // Source: orchestration/interfaces.go StepResult.StartTime, EndTime
            const calculateWaitTime = (step, result) => {
                const dependsOn = step.depends_on || [];
                if (dependsOn.length === 0) return null;
                if (!isValidTimestamp(result?.start_time)) return null;

                // Find the latest end_time among all dependencies
                let latestDepEndTime = null;
                dependsOn.forEach(depId => {
                    const depResult = stepResults[depId];
                    if (isValidTimestamp(depResult?.end_time)) {
                        const depEnd = new Date(depResult.end_time);
                        if (!latestDepEndTime || depEnd > latestDepEndTime) {
                            latestDepEndTime = depEnd;
                        }
                    }
                });

                if (!latestDepEndTime) return null;

                const stepStart = new Date(result.start_time);
                const waitMs = stepStart - latestDepEndTime;
                return waitMs >= 0 ? waitMs : 0;
            };

            // Helper to get duration in ms from result
            // Source: orchestration/interfaces.go StepResult.Duration (stored as nanoseconds)
            const getDurationMs = (result) => {
                if (!result) return null;
                // Check for pre-computed duration_ms first, then convert from nanoseconds
                if (result.duration_ms) return result.duration_ms;
                if (result.duration) return Math.round(result.duration / 1000000);
                return null;
            };

            container.innerHTML = `
                <div style="overflow-y: auto; height: 100%; padding: 16px;">
                    ${selectedExecution.plan.steps.map((step, idx) => {
                        const result = stepResults[step.step_id];
                        // Determine step status: completed/failed/skipped from result, blocked if current HITL step, pending otherwise
                        let status;
                        if (result) {
                            status = result.success ? 'completed' : (result.skipped ? 'skipped' : 'failed');
                        } else if (currentStepId === step.step_id) {
                            status = 'blocked'; // Awaiting HITL approval
                        } else {
                            status = 'pending';
                        }
                        // Get capability from metadata first (that's where orchestration stores it), then other fields
                        const capability = step.metadata?.capability || result?.metadata?.capability || result?.capability || step.capability || step.capability_name || step.agent_name || 'N/A';
                        const agentName = step.agent_name || result?.agent_name || 'N/A';
                        const dependsOn = step.depends_on || [];
                        const usedBy = usedByMap[step.step_id] || [];
                        const hasDependencies = dependsOn.length > 0 || usedBy.length > 0;

                        // Timing data from orchestration/interfaces.go StepResult
                        const durationMs = getDurationMs(result);
                        const waitTimeMs = calculateWaitTime(step, result);

                        // Status-based step number colors
                        const stepNumColors = {
                            'completed': 'background: linear-gradient(135deg, rgba(50, 215, 75, 0.3), rgba(50, 215, 75, 0.15)); color: #32d74b; border: 1px solid rgba(50, 215, 75, 0.4);',
                            'failed': 'background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.15)); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.4);',
                            'skipped': 'background: linear-gradient(135deg, rgba(128, 128, 128, 0.3), rgba(128, 128, 128, 0.15)); color: #888; border: 1px solid rgba(128, 128, 128, 0.4);',
                            'pending': 'background: linear-gradient(135deg, rgba(255, 179, 64, 0.3), rgba(255, 179, 64, 0.15)); color: #ffb340; border: 1px solid rgba(255, 179, 64, 0.4);',
                            'blocked': 'background: linear-gradient(135deg, rgba(255, 59, 48, 0.3), rgba(255, 59, 48, 0.15)); color: #ff3b30; border: 1px solid rgba(255, 59, 48, 0.4);'
                        };

                        return `
                            <div class="dag-step-card ${status}">
                                <div class="dag-step-header">
                                    <div class="dag-step-title">
                                        <span class="dag-step-number" style="${stepNumColors[status]} padding: 4px 12px; border-radius: 8px; font-weight: 700; font-size: 12px;">Step ${idx + 1}</span>
                                        <span class="dag-step-id">${step.step_id}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        ${durationMs !== null ? `<span class="timing-badge execution-time" data-tooltip="⏱ Execution Time\n\nHow long this step took to execute from start to completion.">⏱ ${formatDuration(durationMs)}</span>` : ''}
                                        ${waitTimeMs !== null && waitTimeMs > 0 ? `<span class="timing-badge wait-time" data-tooltip="⏳ Wait Time\n\nTime this step spent waiting for its dependencies to complete before starting execution.">⏳ ${formatDuration(waitTimeMs)}</span>` : ''}
                                        <span class="dag-step-status ${status}">
                                            ${status === 'completed' ? '✓ Completed' : status === 'failed' ? '✗ Failed' : status === 'skipped' ? '⊘ Skipped' : status === 'blocked' ? '⏸ Blocked' : '◐ Pending'}
                                        </span>
                                    </div>
                                </div>
                                <div class="dag-step-body">
                                    <div class="dag-step-info">
                                        <span class="dag-step-label">Agent</span>
                                        <span class="dag-step-value highlight">${agentName}</span>
                                        <span class="dag-step-label">Capability</span>
                                        <span class="dag-step-value" style="color: var(--accent-purple);">${capability}</span>
                                        ${step.instruction ? `
                                            <span class="dag-step-label">Instruction</span>
                                            <span class="dag-step-value">${escapeHtml(step.instruction)}</span>
                                        ` : ''}
                                    </div>
                                    ${hasDependencies ? `
                                        <div class="dag-step-depends">
                                            ${dependsOn.length > 0 ? `
                                                <div class="dag-step-depends-row">
                                                    <span class="dag-step-depends-label">⬅ Waits for:</span>
                                                    <div class="dag-step-depends-list">
                                                        ${dependsOn.map(dep => `<span class="dag-step-depends-item">${dep}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${usedBy.length > 0 ? `
                                                <div class="dag-step-depends-row">
                                                    <span class="dag-step-depends-label">➡ Used by:</span>
                                                    <div class="dag-step-depends-list">
                                                        ${usedBy.map(dep => `<span class="dag-step-depends-item used-by">${dep}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    ${result?.error ? `
                                        <div class="dag-step-error">
                                            <strong>Error:</strong> ${result.error}
                                        </div>
                                    ` : ''}
                                    ${result?.response ? `
                                        <div class="dag-step-response">
                                            <div class="dag-step-response-header" onclick="toggleStepResponse('${step.step_id}')">
                                                <span><span class="expand-arrow">▶</span> View Response</span>
                                                <span style="color: var(--text-muted);">Click to expand</span>
                                            </div>
                                            <div id="step-response-${step.step_id}" class="dag-step-response-content" style="display: none;">
                                                ${formatResponseJson(result.response)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Render LLM Calls tab
        function renderLLMCalls(container) {
            if (!selectedExecution?.llm_interactions?.length) {
                container.innerHTML = `
                    <div class="empty-detail">
                        <div class="empty-detail-icon">🤖</div>
                        <div>No LLM calls recorded for this execution</div>
                    </div>`;
                return;
            }

            const summary = selectedExecution.llm_debug_summary;
            const interactions = selectedExecution.llm_interactions;

            container.innerHTML = `
                <div style="overflow-y: auto; height: 100%; padding: 16px;">
                    ${summary ? `
                        <div class="dag-step-card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(10, 132, 255, 0.2) 0%, rgba(10, 132, 255, 0.08) 100%); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(10, 132, 255, 0.3); box-shadow: 0 8px 32px rgba(10, 132, 255, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);">
                            <div class="dag-step-header">
                                <div class="dag-step-title">
                                    <span style="font-size: 16px; font-weight: 600; color: var(--accent-blue);">🤖 LLM Summary</span>
                                </div>
                            </div>
                            <div class="dag-step-body">
                                <div class="dag-step-info" style="grid-template-columns: repeat(4, 1fr);">
                                    <span class="dag-step-label">Total Calls</span>
                                    <span class="dag-step-value highlight" style="font-size: 18px; font-weight: 700;">${summary.total_calls}</span>
                                    <span class="dag-step-label">Input Tokens</span>
                                    <span class="dag-step-value" style="color: var(--accent-teal);">${summary.total_tokens_in?.toLocaleString() || 0}</span>
                                    <span class="dag-step-label">Output Tokens</span>
                                    <span class="dag-step-value" style="color: var(--accent-purple);">${summary.total_tokens_out?.toLocaleString() || 0}</span>
                                    <span class="dag-step-label">Total Duration</span>
                                    <span class="dag-step-value">${formatDuration(summary.total_duration_ms || 0)}</span>
                                </div>
                                ${summary.provider_breakdown ? `
                                    <div style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap;">
                                        ${Object.entries(summary.provider_breakdown).map(([provider, count]) => `
                                            <span style="padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; background: linear-gradient(135deg, rgba(10, 132, 255, 0.25), rgba(10, 132, 255, 0.1)); border: 1px solid rgba(10, 132, 255, 0.3); color: var(--accent-blue);">
                                                ${provider}: ${count} call${count > 1 ? 's' : ''}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${interactions.map((interaction, idx) => {
                        const typeConfig = {
                            'tiered_selection': { bg: 'rgba(99, 102, 241, 0.15)', border: 'rgba(99, 102, 241, 0.3)', glow: 'rgba(99, 102, 241, 0.1)', color: '#818cf8', icon: '🎯' },
                            'plan_generation': { bg: 'rgba(218, 143, 255, 0.15)', border: 'rgba(218, 143, 255, 0.3)', glow: 'rgba(218, 143, 255, 0.1)', color: 'var(--accent-purple)', icon: '📋' },
                            'synthesis': { bg: 'rgba(52, 211, 153, 0.12)', border: 'rgba(52, 211, 153, 0.25)', glow: 'rgba(52, 211, 153, 0.08)', color: '#34d399', icon: '🔗' },
                            'synthesis_streaming': { bg: 'rgba(52, 211, 153, 0.12)', border: 'rgba(52, 211, 153, 0.25)', glow: 'rgba(52, 211, 153, 0.08)', color: '#34d399', icon: '🔗' },
                            'micro_resolution': { bg: 'rgba(100, 210, 255, 0.15)', border: 'rgba(100, 210, 255, 0.3)', glow: 'rgba(100, 210, 255, 0.1)', color: 'var(--accent-teal)', icon: '🔍' },
                            'semantic_retry': { bg: 'rgba(255, 110, 180, 0.15)', border: 'rgba(255, 110, 180, 0.3)', glow: 'rgba(255, 110, 180, 0.1)', color: 'var(--accent-pink)', icon: '🔄' },
                            'correction': { bg: 'rgba(255, 179, 64, 0.15)', border: 'rgba(255, 179, 64, 0.3)', glow: 'rgba(255, 179, 64, 0.1)', color: 'var(--accent-orange)', icon: '🔧' },
                            'error_analysis': { bg: 'rgba(255, 107, 107, 0.15)', border: 'rgba(255, 107, 107, 0.3)', glow: 'rgba(255, 107, 107, 0.1)', color: 'var(--accent-red)', icon: '⚠️' }
                        };
                        const config = typeConfig[interaction.type] || { bg: 'rgba(255, 255, 255, 0.08)', border: 'rgba(255, 255, 255, 0.15)', glow: 'rgba(255, 255, 255, 0.05)', color: 'var(--text-secondary)', icon: '💬' };

                        return `
                            <div class="dag-step-card" style="background: linear-gradient(135deg, ${config.bg} 0%, rgba(255, 255, 255, 0.03) 100%); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); border: 1px solid ${config.border}; box-shadow: 0 8px 32px ${config.glow}, inset 0 1px 0 rgba(255, 255, 255, 0.08);">
                                <div class="dag-step-header">
                                    <div class="dag-step-title">
                                        <span style="padding: 4px 12px; border-radius: 8px; font-weight: 700; font-size: 12px; background: linear-gradient(135deg, ${config.bg}, rgba(255, 255, 255, 0.05)); border: 1px solid ${config.border}; color: ${config.color};">${config.icon} #${idx + 1}</span>
                                        <span class="dag-step-id" style="color: ${config.color}; font-weight: 600;">${interaction.type || 'Unknown'}</span>
                                        ${interaction.step_id ? `<span class="step-id-badge" title="Associated with step">📍 ${interaction.step_id}</span>` : ''}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-family: 'SF Mono', monospace; font-size: 11px; color: var(--text-muted);">
                                            ${formatDuration(interaction.duration_ms || 0)}
                                        </span>
                                        <span class="dag-step-status ${interaction.success ? 'completed' : 'failed'}">
                                            ${interaction.success ? '✓ Success' : '✗ Failed'}
                                        </span>
                                    </div>
                                </div>
                                <div class="dag-step-body">
                                    <div class="dag-step-info">
                                        <span class="dag-step-label">Provider</span>
                                        <span class="dag-step-value">${(() => {
                                            const provider = (interaction.provider || 'unknown').toLowerCase();
                                            const providerColors = {
                                                'openai': { bg: 'rgba(16, 163, 127, 0.2)', border: 'rgba(16, 163, 127, 0.4)', color: '#10a37f' },
                                                'anthropic': { bg: 'rgba(204, 153, 102, 0.2)', border: 'rgba(204, 153, 102, 0.4)', color: '#cc9966' },
                                                'groq': { bg: 'rgba(255, 140, 0, 0.2)', border: 'rgba(255, 140, 0, 0.4)', color: '#ff8c00' },
                                                'gemini': { bg: 'rgba(66, 133, 244, 0.2)', border: 'rgba(66, 133, 244, 0.4)', color: '#4285f4' },
                                                'deepseek': { bg: 'rgba(0, 122, 255, 0.2)', border: 'rgba(0, 122, 255, 0.4)', color: '#007aff' },
                                                'default': { bg: 'rgba(150, 150, 150, 0.2)', border: 'rgba(150, 150, 150, 0.4)', color: '#aaaaaa' }
                                            };
                                            const colors = providerColors[provider] || providerColors['default'];
                                            return '<span style="display: inline-block; padding: 3px 10px; background: linear-gradient(135deg, ' + colors.bg + ' 0%, rgba(255,255,255,0.05) 100%); border: 1px solid ' + colors.border + '; border-radius: 5px; font-size: 12px; font-weight: 600; color: ' + colors.color + '; letter-spacing: 0.3px;">' + (interaction.provider || 'Unknown') + '</span>';
                                        })()}</span>
                                        <span class="dag-step-label">Model</span>
                                        <span class="dag-step-value" style="color: var(--accent-teal);">${interaction.model || 'N/A'}</span>
                                        <span class="dag-step-label">Tokens</span>
                                        <span class="dag-step-value"><span style="color: var(--accent-green);">${interaction.prompt_tokens || 0}</span> in / <span style="color: var(--accent-purple);">${interaction.completion_tokens || 0}</span> out</span>
                                        <span class="dag-step-label">Temperature</span>
                                        <span class="dag-step-value">${interaction.temperature ?? 'N/A'}</span>
                                    </div>
                                    ${interaction.error ? `
                                        <div class="dag-step-error">
                                            <strong>Error:</strong> ${interaction.error}
                                        </div>
                                    ` : ''}
                                    <div class="dag-step-response" style="background: rgba(0, 0, 0, 0.15); border-radius: 12px; margin-top: 12px; overflow: hidden;">
                                        <div class="dag-step-response-header" onclick="toggleLLMInteraction('${idx}', 'prompt')" style="background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid rgba(255, 255, 255, 0.06);">
                                            <span><span class="expand-arrow" id="llm-prompt-arrow-${idx}">▶</span> View Prompt</span>
                                            <span style="display: flex; align-items: center; gap: 8px;">
                                                <button class="copy-inline-btn" onclick="event.stopPropagation(); copyDAGLLMContent(${idx}, 'prompt', event)">Copy</button>
                                                <span style="color: var(--text-muted); font-size: 10px;">${(interaction.prompt_tokens || 0).toLocaleString()} tokens</span>
                                            </span>
                                        </div>
                                        <div id="llm-prompt-${idx}" class="dag-step-response-content" style="display: none; background: rgba(0, 0, 0, 0.2);">
                                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-size: 11px; color: var(--text-secondary);">${escapeHtml(interaction.prompt || '')}</pre>
                                        </div>
                                    </div>
                                    <div class="dag-step-response" style="background: rgba(0, 0, 0, 0.15); border-radius: 12px; margin-top: 8px; overflow: hidden;">
                                        <div class="dag-step-response-header" onclick="toggleLLMInteraction('${idx}', 'response')" style="background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid rgba(255, 255, 255, 0.06);">
                                            <span><span class="expand-arrow" id="llm-response-arrow-${idx}">▶</span> View Response</span>
                                            <span style="display: flex; align-items: center; gap: 8px;">
                                                <button class="copy-inline-btn" onclick="event.stopPropagation(); copyDAGLLMContent(${idx}, 'response', event)">Copy</button>
                                                <span style="color: var(--text-muted); font-size: 10px;">${(interaction.completion_tokens || 0).toLocaleString()} tokens</span>
                                            </span>
                                        </div>
                                        <div id="llm-response-${idx}" class="dag-step-response-content" style="display: none; background: rgba(0, 0, 0, 0.2);">
                                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-size: 11px; color: var(--text-secondary);">${escapeHtml(interaction.response || '')}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function toggleLLMInteraction(idx, type) {
            const content = document.getElementById(`llm-${type}-${idx}`);
            const arrow = document.getElementById(`llm-${type}-arrow-${idx}`);
            if (content) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                if (arrow) arrow.textContent = isHidden ? '▼' : '▶';
            }
        }

        // Render HITL Checkpoints tab
        function renderHITLCheckpoints(container) {
            if (!selectedExecution?.hitl_checkpoints?.length) {
                container.innerHTML = `
                    <div class="empty-detail">
                        <div class="empty-detail-icon">🛑</div>
                        <div>No HITL checkpoints for this execution</div>
                    </div>`;
                return;
            }

            const checkpoints = selectedExecution.hitl_checkpoints;

            container.innerHTML = `
                <div style="overflow-y: auto; height: 100%; padding: 16px;">
                    ${checkpoints.map((checkpoint, idx) => {
                        const statusColors = {
                            'pending': 'rgba(255, 179, 64, 0.2)',
                            'approved': 'rgba(50, 215, 75, 0.2)',
                            'rejected': 'rgba(255, 107, 107, 0.2)',
                            'expired': 'rgba(128, 128, 128, 0.2)'
                        };
                        const bgColor = statusColors[checkpoint.status] || 'rgba(255, 255, 255, 0.08)';

                        return `
                            <div class="dag-step-card" style="background: linear-gradient(135deg, ${bgColor} 0%, rgba(255, 255, 255, 0.02) 100%);">
                                <div class="dag-step-header">
                                    <div class="dag-step-title">
                                        <span class="dag-step-number">#${idx + 1}</span>
                                        <span class="dag-step-id">${checkpoint.interrupt_point || 'Checkpoint'}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span class="dag-step-status ${checkpoint.status === 'approved' ? 'completed' : checkpoint.status === 'rejected' ? 'failed' : 'pending'}">
                                            ${checkpoint.status === 'approved' ? '✓ Approved' :
                                              checkpoint.status === 'rejected' ? '✗ Rejected' :
                                              checkpoint.status === 'expired' ? '⊘ Expired' : '◐ Pending'}
                                        </span>
                                    </div>
                                </div>
                                <div class="dag-step-body">
                                    <div class="dag-step-info">
                                        <span class="dag-step-label">Checkpoint ID</span>
                                        <span class="dag-step-value" style="font-family: 'SF Mono', monospace; font-size: 11px;">${checkpoint.checkpoint_id}</span>
                                        ${checkpoint.agent_name ? `
                                            <span class="dag-step-label">Agent</span>
                                            <span class="dag-step-value highlight">${checkpoint.agent_name}</span>
                                        ` : ''}
                                        <span class="dag-step-label">Created</span>
                                        <span class="dag-step-value">${new Date(checkpoint.created_at).toLocaleString()}</span>
                                        <span class="dag-step-label">Expires</span>
                                        <span class="dag-step-value">${new Date(checkpoint.expires_at).toLocaleString()}</span>
                                    </div>
                                    ${checkpoint.decision ? `
                                        <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                            <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">Decision Context</div>
                                            <div class="dag-step-info">
                                                <span class="dag-step-label">Reason</span>
                                                <span class="dag-step-value">${checkpoint.decision.reason || 'N/A'}</span>
                                                <span class="dag-step-label">Priority</span>
                                                <span class="dag-step-value">${checkpoint.decision.priority || 'N/A'}</span>
                                                ${checkpoint.decision.message ? `
                                                    <span class="dag-step-label">Message</span>
                                                    <span class="dag-step-value" style="grid-column: span 3;">${checkpoint.decision.message}</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${checkpoint.current_step ? `
                                        <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                            <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">Current Step</div>
                                            <div class="dag-step-info">
                                                <span class="dag-step-label">Step ID</span>
                                                <span class="dag-step-value">${checkpoint.current_step.step_id || 'N/A'}</span>
                                                <span class="dag-step-label">Capability</span>
                                                <span class="dag-step-value highlight">${checkpoint.current_step.capability || 'N/A'}</span>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${checkpoint.resolved_parameters ? `
                                        <div class="dag-step-response">
                                            <div class="dag-step-response-header" onclick="toggleHITLSection('${checkpoint.checkpoint_id}', 'params')">
                                                <span><span class="expand-arrow" id="hitl-params-arrow-${checkpoint.checkpoint_id}">▶</span> Resolved Parameters</span>
                                            </div>
                                            <div id="hitl-params-${checkpoint.checkpoint_id}" class="dag-step-response-content" style="display: none;">
                                                ${formatResponseJson(checkpoint.resolved_parameters)}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${checkpoint.plan ? `
                                        <div class="dag-step-response">
                                            <div class="dag-step-response-header" onclick="toggleHITLSection('${checkpoint.checkpoint_id}', 'plan')">
                                                <span><span class="expand-arrow" id="hitl-plan-arrow-${checkpoint.checkpoint_id}">▶</span> Execution Plan (${checkpoint.plan.steps?.length || 0} steps)</span>
                                            </div>
                                            <div id="hitl-plan-${checkpoint.checkpoint_id}" class="dag-step-response-content" style="display: none;">
                                                ${formatResponseJson(checkpoint.plan)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function toggleHITLSection(checkpointId, section) {
            const content = document.getElementById(`hitl-${section}-${checkpointId}`);
            const arrow = document.getElementById(`hitl-${section}-arrow-${checkpointId}`);
            if (content) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                if (arrow) arrow.textContent = isHidden ? '▼' : '▶';
            }
        }

        // Escape HTML for safe display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== Initialize ====================
        document.addEventListener('DOMContentLoaded', () => {
            fetchServices();
            setupAutoRefresh();
            setupResizablePanels();
        });
    </script>
</body>
</html>
