.PHONY: help build run test clean docker-build setup deploy k8s-deploy k8s-delete k8s-logs k8s-status

# Default target
.DEFAULT_GOAL := help

# Variables
BINARY_NAME=research-agent-telemetry
DOCKER_IMAGE=research-agent-telemetry:latest
K8S_NAMESPACE=gomind-examples

## help: Show this help message
help:
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@sed -n 's/^##//p' ${MAKEFILE_LIST} | column -t -s ':' | sed -e 's/^/ /'

## build: Build the Go binary
build:
	@echo "ğŸ”¨ Building $(BINARY_NAME)..."
	@go build -o $(BINARY_NAME) .
	@echo "âœ… Build complete: ./$(BINARY_NAME)"

## run: Run the agent locally (requires Redis)
run: build
	@echo "ğŸš€ Starting $(BINARY_NAME)..."
	@echo "ğŸ“‹ Make sure Redis is running: docker run -p 6379:6379 redis:7-alpine"
	@./$(BINARY_NAME)

## test: Run tests
test:
	@echo "ğŸ§ª Running tests..."
	@go test -v ./...

## clean: Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -f $(BINARY_NAME)
	@rm -f *.test
	@rm -f *.out
	@echo "âœ… Clean complete"

## docker-build: Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image $(DOCKER_IMAGE)..."
	@docker build -t $(DOCKER_IMAGE) .
	@echo "âœ… Docker image built: $(DOCKER_IMAGE)"

## setup: Initial setup (install dependencies, create .env)
setup:
	@echo "ğŸ“¦ Setting up environment..."
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Creating .env from .env.example..."; \
		cp .env.example .env; \
		echo "âš ï¸  Please edit .env and add your API keys"; \
	else \
		echo "â„¹ï¸  .env already exists"; \
	fi
	@echo "ğŸ“¥ Downloading Go dependencies..."
	@go mod download
	@echo "âœ… Setup complete"

## deploy: Deploy to local Kind cluster
deploy: docker-build
	@echo "â˜¸ï¸  Deploying to Kind cluster..."
	@kind load docker-image $(DOCKER_IMAGE) --name gomind-demo || echo "âš ï¸  Kind cluster 'gomind-demo' not found. Run setup-kind-demo.sh first"
	@kubectl apply -f k8-deployment.yaml
	@echo "âœ… Deployment complete"

## k8s-deploy: Deploy to Kubernetes
k8s-deploy:
	@echo "â˜¸ï¸  Deploying to Kubernetes..."
	@kubectl create namespace $(K8S_NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
	@kubectl apply -f k8-deployment.yaml
	@echo "âœ… Deployed to namespace: $(K8S_NAMESPACE)"
	@echo "ğŸ“‹ Check status with: kubectl get pods -n $(K8S_NAMESPACE)"

## k8s-delete: Delete from Kubernetes
k8s-delete:
	@echo "ğŸ—‘ï¸  Deleting from Kubernetes..."
	@kubectl delete -f k8-deployment.yaml --ignore-not-found=true
	@echo "âœ… Deleted"

## k8s-logs: View Kubernetes logs
k8s-logs:
	@kubectl logs -f -l app=research-agent-telemetry -n $(K8S_NAMESPACE)

## k8s-status: Check Kubernetes deployment status
k8s-status:
	@echo "ğŸ“Š Deployment Status:"
	@kubectl get deployments -n $(K8S_NAMESPACE) -l app=research-agent-telemetry
	@echo ""
	@echo "ğŸ“¦ Pods:"
	@kubectl get pods -n $(K8S_NAMESPACE) -l app=research-agent-telemetry
	@echo ""
	@echo "ğŸŒ Services:"
	@kubectl get services -n $(K8S_NAMESPACE) -l app=research-agent-telemetry

## dev: Run in development mode with live reload (requires air)
dev:
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âŒ 'air' not found. Install it with: go install github.com/cosmtrek/air@latest"; \
		exit 1; \
	fi

## fmt: Format code
fmt:
	@echo "ğŸ¨ Formatting code..."
	@go fmt ./...
	@echo "âœ… Code formatted"

## vet: Run go vet
vet:
	@echo "ğŸ” Running go vet..."
	@go vet ./...
	@echo "âœ… Vet complete"

## lint: Run golangci-lint (if installed)
lint:
	@if command -v golangci-lint > /dev/null; then \
		echo "ğŸ” Running golangci-lint..."; \
		golangci-lint run; \
		echo "âœ… Lint complete"; \
	else \
		echo "âš ï¸  golangci-lint not installed. Install from https://golangci-lint.run/"; \
	fi

## check: Run all checks (fmt, vet, lint, test)
check: fmt vet lint test
	@echo "âœ… All checks passed"
